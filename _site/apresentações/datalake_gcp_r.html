<!DOCTYPE html>
<html lang="en"><head>
<link href="../imagens/cafe1.png" rel="icon" type="image/png">
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/tabby.min.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.7.32">

  <title>Jennifer Luz Lopes ‚Äì Data Lake na GCP com R</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="../site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../site_libs/revealjs/dist/theme/quarto-18e07a0c81f49f8faf7052c2b881f862.css">
  <link href="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/font-awesome/css/all.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/reveal-chalkboard/style.css" rel="stylesheet">
  <link href="../site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Data Lake na GCP com R</h1>
  <p class="subtitle">Criando um Data Lake do Zero usando Google Cloud Platform</p>

<div class="quarto-title-authors">
</div>

</section>
<section id="introdu√ß√£o" class="slide level2" data-background-color="#4285F4">
<h2>Introdu√ß√£o</h2>
<p><strong>Data Lake</strong> √© uma arquitetura de armazenamento centralizada que permite guardar dados estruturados, semi-estruturados e n√£o estruturados em qualquer escala.</p>
<p><strong>Objetivo desta apresenta√ß√£o:</strong></p>
<p>Construir um Data Lake completo na <strong>Google Cloud Platform (GCP)</strong> usando principalmente <strong>R</strong>, desde a configura√ß√£o inicial at√© o consumo anal√≠tico.</p>
<p><strong>Exemplo pr√°tico:</strong> Dados agr√≠colas de produ√ß√£o de culturas</p>
</section>
<section id="por-que-gcp-para-data-lake" class="slide level2" data-background-color="#4285F4">
<h2>Por que GCP para Data Lake?</h2>
<p><strong>Vantagens do Google Cloud Platform:</strong></p>
<ul>
<li><strong>BigQuery</strong>: Data warehouse serverless, r√°pido e escal√°vel</li>
<li><strong>Cloud Storage</strong>: Armazenamento ilimitado de baixo custo</li>
<li><strong>Integra√ß√£o nativa</strong>: Ferramentas se conectam facilmente</li>
<li><strong>Custo-benef√≠cio</strong>: Pay-as-you-go, sem infraestrutura</li>
<li><strong>Seguran√ßa</strong>: Gerenciamento de acessos integrado</li>
</ul>
<p><strong>E o melhor:</strong> Podemos fazer quase tudo pelo R!</p>
</section>
<section id="arquitetura-bronze-silver-gold" class="slide level2" data-background-color="#34A853">
<h2>Arquitetura Bronze-Silver-Gold</h2>
<p><strong>Camadas do Data Lake:</strong></p>
<p><strong>ü•â Bronze (Raw Data):</strong> - Dados brutos, exatamente como chegaram - Sem transforma√ß√£o ou limpeza - Hist√≥rico completo preservado</p>
<p><strong>ü•à Silver (Cleaned &amp; Enriched):</strong> - Dados limpos, validados - Tipos de dados corretos - Enriquecimento b√°sico</p>
<p><strong>ü•á Gold (Analytics Ready):</strong> - Agrega√ß√µes e m√©tricas de neg√≥cio - Dados prontos para an√°lise - Otimizados para consumo</p>
</section>
<section id="vis√£o-geral-do-fluxo" class="slide level2" data-background-color="#34A853">
<h2>Vis√£o Geral do Fluxo</h2>
<p><strong>Pipeline Completo:</strong></p>
<ol type="1">
<li>‚òÅÔ∏è Prepara√ß√£o m√≠nima no Google Cloud</li>
<li>üîê Autentica√ß√£o no R</li>
<li>üèóÔ∏è Cria√ß√£o da estrutura do Data Lake (datasets)</li>
<li>üì• Ingest√£o de dados brutos (Bronze)</li>
<li>üîÑ Transforma√ß√µes e enriquecimento (Silver)</li>
<li>üìä M√©tricas anal√≠ticas consolidadas (Gold)</li>
<li>üéØ Consumo anal√≠tico via R + dbplyr</li>
<li>üìù Relat√≥rio reprodut√≠vel (Quarto)</li>
<li>üîí Governan√ßa e compartilhamento</li>
</ol>
</section>
<section id="nosso-exemplo-dados-agr√≠colas" class="slide level2" data-background-color="#FBBC04">
<h2>Nosso Exemplo: Dados Agr√≠colas</h2>
<p><strong>Contexto:</strong></p>
<p>Sistema de monitoramento de produ√ß√£o agr√≠cola com dados de m√∫ltiplas fazendas.</p>
<p><strong>Vari√°veis que vamos trabalhar:</strong></p>
<ul>
<li>Informa√ß√µes de safras (fazenda, cultura, √°rea plantada)</li>
<li>Produ√ß√£o e produtividade</li>
<li>Dados clim√°ticos (temperatura, precipita√ß√£o)</li>
<li>Insumos aplicados (fertilizantes, defensivos)</li>
<li>Custos e receitas</li>
</ul>
<p><strong>Objetivo:</strong> Do dado bruto √† an√°lise de rentabilidade por cultura</p>
</section>
<section class="slide level2">

</section>
<section>
<section id="prepara√ß√£o-no-google-cloud" class="title-slide slide level1 center" data-background-color="#4285F4">
<h1>1. Prepara√ß√£o no Google Cloud</h1>

</section>
<section id="criando-o-projeto-gcp" class="slide level2">
<h2>1.1 Criando o Projeto GCP</h2>
<p><strong>Passos iniciais no Google Cloud Console:</strong></p>
<ol type="1">
<li>Acesse: https://console.cloud.google.com</li>
<li>Crie um novo projeto: ‚Äúdatalake-agricola‚Äù</li>
<li>Anote o <strong>Project ID</strong> (ser√° usado no R)</li>
</ol>
<p><strong>Ativar APIs necess√°rias:</strong></p>
<ul>
<li>BigQuery API</li>
<li>Cloud Storage API</li>
<li>Cloud Resource Manager API</li>
</ul>
<p><strong>Menu:</strong> APIs &amp; Services ‚Üí Library ‚Üí Buscar e ativar cada API</p>
</section>
<section id="criando-service-account" class="slide level2">
<h2>1.2 Criando Service Account</h2>
<p><strong>Service Account = credenciais para o R acessar GCP</strong></p>
<p><strong>No Console GCP:</strong></p>
<ol type="1">
<li>Menu: IAM &amp; Admin ‚Üí Service Accounts</li>
<li>Clique em ‚ÄúCreate Service Account‚Äù</li>
<li>Nome: ‚Äúr-datalake-access‚Äù</li>
<li>Descri√ß√£o: ‚ÄúAcesso R para manipular Data Lake‚Äù</li>
</ol>
<p><strong>Permiss√µes necess√°rias:</strong></p>
<ul>
<li>BigQuery Admin (ou Data Editor + Job User)</li>
<li>Storage Admin (ou Object Admin)</li>
</ul>
</section>
<section id="gerando-chave-json" class="slide level2">
<h2>1.3 Gerando Chave JSON</h2>
<p><strong>Baixar credenciais:</strong></p>
<ol type="1">
<li>Na lista de Service Accounts, clique nos 3 pontos</li>
<li>‚ÄúManage Keys‚Äù ‚Üí ‚ÄúAdd Key‚Äù ‚Üí ‚ÄúCreate New Key‚Äù</li>
<li>Tipo: <strong>JSON</strong></li>
<li>Arquivo ser√° baixado (ex: <code>datalake-agricola-xxxxx.json</code>)</li>
</ol>
<p><strong>IMPORTANTE:</strong></p>
<ul>
<li>Guarde esse arquivo em local seguro</li>
<li><strong>NUNCA</strong> commite no Git</li>
<li>Adicione <code>*.json</code> no <code>.gitignore</code></li>
</ul>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="autentica√ß√£o-no-r" class="title-slide slide level1 center" data-background-color="#4285F4">
<h1>2. Autentica√ß√£o no R</h1>

</section>
<section id="instalando-pacotes" class="slide level2">
<h2>2.1 Instalando Pacotes</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a></a><span class="co"># Pacotes principais</span></span>
<span id="cb1-2"><a></a><span class="fu">install.packages</span>(<span class="st">"bigrquery"</span>)    <span class="co"># Interface com BigQuery</span></span>
<span id="cb1-3"><a></a><span class="fu">install.packages</span>(<span class="st">"googleCloudStorageR"</span>)  <span class="co"># Cloud Storage</span></span>
<span id="cb1-4"><a></a><span class="fu">install.packages</span>(<span class="st">"gargle"</span>)       <span class="co"># Autentica√ß√£o Google</span></span>
<span id="cb1-5"><a></a><span class="fu">install.packages</span>(<span class="st">"DBI"</span>)          <span class="co"># Interface de banco de dados</span></span>
<span id="cb1-6"><a></a><span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)        <span class="co"># Manipula√ß√£o de dados</span></span>
<span id="cb1-7"><a></a><span class="fu">install.packages</span>(<span class="st">"dbplyr"</span>)       <span class="co"># dplyr para bancos de dados</span></span>
<span id="cb1-8"><a></a><span class="fu">install.packages</span>(<span class="st">"lubridate"</span>)    <span class="co"># Datas</span></span>
<span id="cb1-9"><a></a><span class="fu">install.packages</span>(<span class="st">"jsonlite"</span>)     <span class="co"># Trabalhar com JSON</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="configurando-autentica√ß√£o" class="slide level2">
<h2>2.2 Configurando Autentica√ß√£o</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a></a><span class="fu">library</span>(bigrquery)</span>
<span id="cb2-2"><a></a><span class="fu">library</span>(DBI)</span>
<span id="cb2-3"><a></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-4"><a></a></span>
<span id="cb2-5"><a></a><span class="co"># Definir vari√°veis de ambiente</span></span>
<span id="cb2-6"><a></a><span class="co"># SUBSTITUA com seu Project ID e caminho da chave</span></span>
<span id="cb2-7"><a></a>project_id <span class="ot">&lt;-</span> <span class="st">"datalake-agricola"</span></span>
<span id="cb2-8"><a></a>key_file <span class="ot">&lt;-</span> <span class="st">"~/credenciais/datalake-agricola-xxxxx.json"</span></span>
<span id="cb2-9"><a></a></span>
<span id="cb2-10"><a></a><span class="co"># Autenticar</span></span>
<span id="cb2-11"><a></a><span class="fu">bq_auth</span>(<span class="at">path =</span> key_file)</span>
<span id="cb2-12"><a></a></span>
<span id="cb2-13"><a></a><span class="co"># Testar conex√£o</span></span>
<span id="cb2-14"><a></a><span class="fu">bq_projects</span>()  <span class="co"># Deve listar seus projetos</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Dica:</strong> Use <code>.Renviron</code> para vari√°veis de ambiente permanentes</p>
</section>
<section id="criando-conex√£o-dbi" class="slide level2">
<h2>2.3 Criando Conex√£o DBI</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a></a><span class="co"># Criar conex√£o DBI para usar com dbplyr</span></span>
<span id="cb3-2"><a></a>con <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb3-3"><a></a>  bigrquery<span class="sc">::</span><span class="fu">bigquery</span>(),</span>
<span id="cb3-4"><a></a>  <span class="at">project =</span> project_id,</span>
<span id="cb3-5"><a></a>  <span class="at">dataset =</span> <span class="st">"bronze"</span>,  <span class="co"># come√ßaremos pelo bronze</span></span>
<span id="cb3-6"><a></a>  <span class="at">billing =</span> project_id</span>
<span id="cb3-7"><a></a>)</span>
<span id="cb3-8"><a></a></span>
<span id="cb3-9"><a></a><span class="co"># Testar</span></span>
<span id="cb3-10"><a></a><span class="fu">dbListTables</span>(con)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Por que DBI?</strong></p>
<p>Permite usar <code>dplyr</code> diretamente nas tabelas BigQuery sem trazer dados para mem√≥ria!</p>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="estrutura-do-data-lake" class="title-slide slide level1 center" data-background-color="#34A853">
<h1>3. Estrutura do Data Lake</h1>

</section>
<section id="criando-datasets-camadas" class="slide level2">
<h2>3.1 Criando Datasets (Camadas)</h2>
<p><strong>Datasets no BigQuery = Schemas em bancos SQL</strong></p>
<p>Cada camada ter√° seu pr√≥prio dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a></a><span class="co"># Criar dataset Bronze</span></span>
<span id="cb4-2"><a></a><span class="fu">bq_dataset_create</span>(</span>
<span id="cb4-3"><a></a>  <span class="fu">bq_dataset</span>(project_id, <span class="st">"bronze"</span>),</span>
<span id="cb4-4"><a></a>  <span class="at">location =</span> <span class="st">"US"</span>  <span class="co"># ou "southamerica-east1" (S√£o Paulo)</span></span>
<span id="cb4-5"><a></a>)</span>
<span id="cb4-6"><a></a></span>
<span id="cb4-7"><a></a><span class="co"># Criar dataset Silver</span></span>
<span id="cb4-8"><a></a><span class="fu">bq_dataset_create</span>(</span>
<span id="cb4-9"><a></a>  <span class="fu">bq_dataset</span>(project_id, <span class="st">"silver"</span>),</span>
<span id="cb4-10"><a></a>  <span class="at">location =</span> <span class="st">"US"</span></span>
<span id="cb4-11"><a></a>)</span>
<span id="cb4-12"><a></a></span>
<span id="cb4-13"><a></a><span class="co"># Criar dataset Gold</span></span>
<span id="cb4-14"><a></a><span class="fu">bq_dataset_create</span>(</span>
<span id="cb4-15"><a></a>  <span class="fu">bq_dataset</span>(project_id, <span class="st">"gold"</span>),</span>
<span id="cb4-16"><a></a>  <span class="at">location =</span> <span class="st">"US"</span></span>
<span id="cb4-17"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualizando-estrutura" class="slide level2">
<h2>3.2 Visualizando Estrutura</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a></a><span class="co"># Listar todos os datasets do projeto</span></span>
<span id="cb5-2"><a></a>datasets <span class="ot">&lt;-</span> <span class="fu">bq_project_datasets</span>(project_id)</span>
<span id="cb5-3"><a></a></span>
<span id="cb5-4"><a></a><span class="co"># Ver informa√ß√µes de um dataset espec√≠fico</span></span>
<span id="cb5-5"><a></a><span class="fu">bq_dataset</span>(project_id, <span class="st">"bronze"</span>)</span>
<span id="cb5-6"><a></a></span>
<span id="cb5-7"><a></a><span class="co"># Metadados completos</span></span>
<span id="cb5-8"><a></a><span class="fu">bq_dataset_meta</span>(<span class="fu">bq_dataset</span>(project_id, <span class="st">"bronze"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Resultado esperado:</strong></p>
<ul>
<li>Tr√™s datasets criados: <code>bronze</code>, <code>silver</code>, <code>gold</code></li>
<li>Cada um vazio, pronto para receber tabelas</li>
</ul>
</section>
<section id="organiza√ß√£o-das-tabelas" class="slide level2">
<h2>3.3 Organiza√ß√£o das Tabelas</h2>
<p><strong>Conven√ß√£o de nomenclatura:</strong></p>
<p><strong>Bronze:</strong> <code>raw_</code> + nome_origem</p>
<ul>
<li><code>raw_safras</code></li>
<li><code>raw_clima</code></li>
<li><code>raw_insumos</code></li>
<li><code>raw_custos</code></li>
</ul>
<p><strong>Silver:</strong> nome_limpo</p>
<ul>
<li><code>safras_cleaned</code></li>
<li><code>clima_validated</code></li>
<li><code>insumos_enriched</code></li>
</ul>
<p><strong>Gold:</strong> <code>agg_</code> + m√©trica</p>
<ul>
<li><code>agg_producao_fazenda</code></li>
<li><code>agg_rentabilidade_cultura</code></li>
</ul>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="camada-bronze---ingest√£o" class="title-slide slide level1 center" data-background-color="#CD7F32">
<h1>4. Camada Bronze - Ingest√£o</h1>

</section>
<section id="preparando-dados-exemplo" class="slide level2">
<h2>4.1 Preparando Dados Exemplo</h2>
<p><strong>Vamos simular dados agr√≠colas realistas:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-2"><a></a><span class="fu">library</span>(lubridate)</span>
<span id="cb6-3"><a></a></span>
<span id="cb6-4"><a></a><span class="co"># Dados de safras (raw)</span></span>
<span id="cb6-5"><a></a>raw_safras <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb6-6"><a></a>  <span class="at">safra_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>,</span>
<span id="cb6-7"><a></a>  <span class="at">data_plantio =</span> <span class="fu">seq</span>(<span class="fu">ymd</span>(<span class="st">"2023-01-01"</span>), </span>
<span id="cb6-8"><a></a>                     <span class="at">by =</span> <span class="st">"3 days"</span>, </span>
<span id="cb6-9"><a></a>                     <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb6-10"><a></a>  <span class="at">fazenda =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Fazenda A"</span>, <span class="st">"Fazenda B"</span>, </span>
<span id="cb6-11"><a></a>                      <span class="st">"Fazenda C"</span>), <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-12"><a></a>  <span class="at">cultura =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Soja"</span>, <span class="st">"Milho"</span>, <span class="st">"Trigo"</span>), </span>
<span id="cb6-13"><a></a>                   <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb6-14"><a></a>  <span class="at">area_ha =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">100</span>, <span class="dv">10</span>, <span class="dv">500</span>), <span class="dv">1</span>),</span>
<span id="cb6-15"><a></a>  <span class="at">producao_ton =</span> <span class="cn">NA_real_</span>,  <span class="co"># ser√° preenchido depois</span></span>
<span id="cb6-16"><a></a>  <span class="at">status =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Plantado"</span>, <span class="st">"Colhido"</span>, <span class="st">"Cancelado"</span>), </span>
<span id="cb6-17"><a></a>                  <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>, </span>
<span id="cb6-18"><a></a>                  <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.3</span>, <span class="fl">0.6</span>, <span class="fl">0.1</span>))</span>
<span id="cb6-19"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mais-dados-brutos" class="slide level2">
<h2>4.2 Mais Dados Brutos</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a></a><span class="co"># Dados clim√°ticos</span></span>
<span id="cb7-2"><a></a>raw_clima <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb7-3"><a></a>  <span class="at">data =</span> <span class="fu">seq</span>(<span class="fu">ymd</span>(<span class="st">"2023-01-01"</span>), <span class="fu">ymd</span>(<span class="st">"2023-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb7-4"><a></a>  <span class="at">fazenda =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Fazenda A"</span>, <span class="st">"Fazenda B"</span>, <span class="st">"Fazenda C"</span>), </span>
<span id="cb7-5"><a></a>                   <span class="dv">365</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-6"><a></a>  <span class="at">temp_max =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">365</span>, <span class="dv">25</span>, <span class="dv">38</span>), <span class="dv">1</span>),</span>
<span id="cb7-7"><a></a>  <span class="at">temp_min =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">365</span>, <span class="dv">15</span>, <span class="dv">25</span>), <span class="dv">1</span>),</span>
<span id="cb7-8"><a></a>  <span class="at">precipitacao_mm =</span> <span class="fu">round</span>(<span class="fu">rexp</span>(<span class="dv">365</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>), <span class="dv">1</span>),  <span class="co"># exponencial</span></span>
<span id="cb7-9"><a></a>  <span class="at">umidade =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">365</span>, <span class="dv">40</span>, <span class="dv">90</span>), <span class="dv">0</span>)</span>
<span id="cb7-10"><a></a>)</span>
<span id="cb7-11"><a></a></span>
<span id="cb7-12"><a></a><span class="co"># Dados de insumos aplicados</span></span>
<span id="cb7-13"><a></a>raw_insumos <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb7-14"><a></a>  <span class="at">aplicacao_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">200</span>,</span>
<span id="cb7-15"><a></a>  <span class="at">safra_id =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="dv">200</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-16"><a></a>  <span class="at">data_aplicacao =</span> <span class="fu">sample</span>(</span>
<span id="cb7-17"><a></a>    <span class="fu">seq</span>(<span class="fu">ymd</span>(<span class="st">"2023-01-01"</span>), <span class="fu">ymd</span>(<span class="st">"2023-12-31"</span>), <span class="at">by =</span> <span class="st">"day"</span>),</span>
<span id="cb7-18"><a></a>    <span class="dv">200</span>, <span class="at">replace =</span> <span class="cn">TRUE</span></span>
<span id="cb7-19"><a></a>  ),</span>
<span id="cb7-20"><a></a>  <span class="at">tipo_insumo =</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Fertilizante"</span>, <span class="st">"Herbicida"</span>, </span>
<span id="cb7-21"><a></a>                         <span class="st">"Fungicida"</span>, <span class="st">"Inseticida"</span>), </span>
<span id="cb7-22"><a></a>                       <span class="dv">200</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb7-23"><a></a>  <span class="at">produto =</span> <span class="fu">paste0</span>(<span class="st">"Produto_"</span>, <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">200</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb7-24"><a></a>  <span class="at">quantidade_kg =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">200</span>, <span class="dv">10</span>, <span class="dv">200</span>), <span class="dv">1</span>),</span>
<span id="cb7-25"><a></a>  <span class="at">custo_total =</span> <span class="fu">round</span>(<span class="fu">runif</span>(<span class="dv">200</span>, <span class="dv">500</span>, <span class="dv">5000</span>), <span class="dv">2</span>)</span>
<span id="cb7-26"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simulando-dados-imperfeitos" class="slide level2">
<h2>4.3 Simulando Dados Imperfeitos</h2>
<p><strong>Bronze = dados como chegam, com problemas!</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a></a><span class="co"># Adicionar imperfei√ß√µes nos dados (realista)</span></span>
<span id="cb8-2"><a></a>raw_safras_dirty <span class="ot">&lt;-</span> raw_safras <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb8-4"><a></a>    <span class="co"># Alguns valores nulos</span></span>
<span id="cb8-5"><a></a>    <span class="at">area_ha =</span> <span class="fu">if_else</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="dv">5</span>), </span>
<span id="cb8-6"><a></a>                      <span class="cn">NA_real_</span>, area_ha),</span>
<span id="cb8-7"><a></a>    <span class="co"># Inconsist√™ncias de texto</span></span>
<span id="cb8-8"><a></a>    <span class="at">fazenda =</span> <span class="fu">if_else</span>(fazenda <span class="sc">==</span> <span class="st">"Fazenda A"</span>, </span>
<span id="cb8-9"><a></a>                      <span class="fu">sample</span>(<span class="fu">c</span>(<span class="st">"Fazenda A"</span>, <span class="st">"Faz A"</span>, <span class="st">"FazendaA"</span>), </span>
<span id="cb8-10"><a></a>                             <span class="fu">n</span>(), <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-11"><a></a>                      fazenda),</span>
<span id="cb8-12"><a></a>    <span class="co"># Datas fora de ordem (erro de digita√ß√£o)</span></span>
<span id="cb8-13"><a></a>    <span class="at">data_plantio =</span> <span class="fu">if_else</span>(<span class="fu">row_number</span>() <span class="sc">%in%</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="dv">3</span>),</span>
<span id="cb8-14"><a></a>                           data_plantio <span class="sc">-</span> <span class="fu">years</span>(<span class="dv">10</span>),</span>
<span id="cb8-15"><a></a>                           data_plantio),</span>
<span id="cb8-16"><a></a>    <span class="co"># Produ√ß√£o: alguns registros j√° t√™m, outros n√£o</span></span>
<span id="cb8-17"><a></a>    <span class="at">producao_ton =</span> <span class="fu">if_else</span>(</span>
<span id="cb8-18"><a></a>      status <span class="sc">==</span> <span class="st">"Colhido"</span>,</span>
<span id="cb8-19"><a></a>      <span class="fu">round</span>(area_ha <span class="sc">*</span> <span class="fu">runif</span>(<span class="fu">n</span>(), <span class="dv">2</span>, <span class="dv">4</span>), <span class="dv">1</span>),  <span class="co"># 2-4 ton/ha</span></span>
<span id="cb8-20"><a></a>      <span class="cn">NA_real_</span></span>
<span id="cb8-21"><a></a>    )</span>
<span id="cb8-22"><a></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="upload-para-bronze" class="slide level2">
<h2>4.4 Upload para Bronze</h2>
<p><strong>M√©todo 1: Upload direto com bigrquery</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a></a><span class="co"># Upload para camada Bronze</span></span>
<span id="cb9-2"><a></a><span class="fu">bq_table_upload</span>(</span>
<span id="cb9-3"><a></a>  <span class="at">x =</span> <span class="fu">bq_table</span>(project_id, <span class="st">"bronze"</span>, <span class="st">"raw_safras"</span>),</span>
<span id="cb9-4"><a></a>  <span class="at">values =</span> raw_safras_dirty,</span>
<span id="cb9-5"><a></a>  <span class="at">fields =</span> <span class="fu">as_bq_fields</span>(raw_safras_dirty),</span>
<span id="cb9-6"><a></a>  <span class="at">create_disposition =</span> <span class="st">"CREATE_IF_NEEDED"</span>,</span>
<span id="cb9-7"><a></a>  <span class="at">write_disposition =</span> <span class="st">"WRITE_TRUNCATE"</span>  <span class="co"># sobrescreve se existir</span></span>
<span id="cb9-8"><a></a>)</span>
<span id="cb9-9"><a></a></span>
<span id="cb9-10"><a></a><span class="co"># Upload clima</span></span>
<span id="cb9-11"><a></a><span class="fu">bq_table_upload</span>(</span>
<span id="cb9-12"><a></a>  <span class="at">x =</span> <span class="fu">bq_table</span>(project_id, <span class="st">"bronze"</span>, <span class="st">"raw_clima"</span>),</span>
<span id="cb9-13"><a></a>  <span class="at">values =</span> raw_clima,</span>
<span id="cb9-14"><a></a>  <span class="at">fields =</span> <span class="fu">as_bq_fields</span>(raw_clima)</span>
<span id="cb9-15"><a></a>)</span>
<span id="cb9-16"><a></a></span>
<span id="cb9-17"><a></a><span class="co"># Upload insumos</span></span>
<span id="cb9-18"><a></a><span class="fu">bq_table_upload</span>(</span>
<span id="cb9-19"><a></a>  <span class="at">x =</span> <span class="fu">bq_table</span>(project_id, <span class="st">"bronze"</span>, <span class="st">"raw_insumos"</span>),</span>
<span id="cb9-20"><a></a>  <span class="at">values =</span> raw_insumos,</span>
<span id="cb9-21"><a></a>  <span class="at">fields =</span> <span class="fu">as_bq_fields</span>(raw_insumos)</span>
<span id="cb9-22"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="verificando-dados-bronze" class="slide level2">
<h2>4.5 Verificando Dados Bronze</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a></a><span class="co"># Reconectar especificando dataset bronze</span></span>
<span id="cb10-2"><a></a>con_bronze <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb10-3"><a></a>  bigrquery<span class="sc">::</span><span class="fu">bigquery</span>(),</span>
<span id="cb10-4"><a></a>  <span class="at">project =</span> project_id,</span>
<span id="cb10-5"><a></a>  <span class="at">dataset =</span> <span class="st">"bronze"</span>,</span>
<span id="cb10-6"><a></a>  <span class="at">billing =</span> project_id</span>
<span id="cb10-7"><a></a>)</span>
<span id="cb10-8"><a></a></span>
<span id="cb10-9"><a></a><span class="co"># Listar tabelas</span></span>
<span id="cb10-10"><a></a><span class="fu">dbListTables</span>(con_bronze)</span>
<span id="cb10-11"><a></a></span>
<span id="cb10-12"><a></a><span class="co"># Query simples para verificar</span></span>
<span id="cb10-13"><a></a>raw_safras_bq <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_bronze, <span class="st">"raw_safras"</span>)</span>
<span id="cb10-14"><a></a></span>
<span id="cb10-15"><a></a><span class="co"># Ver primeiras linhas (ainda no servidor!)</span></span>
<span id="cb10-16"><a></a>raw_safras_bq <span class="sc">%&gt;%</span> </span>
<span id="cb10-17"><a></a>  <span class="fu">head</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-18"><a></a>  <span class="fu">collect</span>()  <span class="co"># s√≥ aqui traz para mem√≥ria</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="metadados-da-tabela-bronze" class="slide level2">
<h2>4.6 Metadados da Tabela Bronze</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a></a><span class="co"># Ver estrutura da tabela</span></span>
<span id="cb11-2"><a></a><span class="fu">bq_table_meta</span>(<span class="fu">bq_table</span>(project_id, <span class="st">"bronze"</span>, <span class="st">"raw_safras"</span>))</span>
<span id="cb11-3"><a></a></span>
<span id="cb11-4"><a></a><span class="co"># Contar registros</span></span>
<span id="cb11-5"><a></a>raw_safras_bq <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a></a>  <span class="fu">summarise</span>(<span class="at">total =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb11-7"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb11-8"><a></a></span>
<span id="cb11-9"><a></a><span class="co"># Estat√≠sticas b√°sicas</span></span>
<span id="cb11-10"><a></a>raw_safras_bq <span class="sc">%&gt;%</span></span>
<span id="cb11-11"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb11-12"><a></a>    <span class="at">total_registros =</span> <span class="fu">n</span>(),</span>
<span id="cb11-13"><a></a>    <span class="at">fazendas_distintas =</span> <span class="fu">n_distinct</span>(fazenda),</span>
<span id="cb11-14"><a></a>    <span class="at">culturas_distintas =</span> <span class="fu">n_distinct</span>(cultura),</span>
<span id="cb11-15"><a></a>    <span class="at">area_total =</span> <span class="fu">sum</span>(area_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-16"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-17"><a></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="camada-silver---limpeza" class="title-slide slide level1 center" data-background-color="#C0C0C0">
<h1>5. Camada Silver - Limpeza</h1>

</section>
<section id="estrat√©gia-de-transforma√ß√£o" class="slide level2">
<h2>5.1 Estrat√©gia de Transforma√ß√£o</h2>
<p><strong>O que fazer na camada Silver:</strong></p>
<ol type="1">
<li><strong>Padronizar</strong> nomes e formatos</li>
<li><strong>Validar</strong> tipos de dados</li>
<li><strong>Limpar</strong> inconsist√™ncias</li>
<li><strong>Enriquecer</strong> com dados calculados b√°sicos</li>
<li><strong>Documentar</strong> regras aplicadas</li>
</ol>
<p><strong>Importante:</strong> Sempre preservar o Bronze original!</p>
</section>
<section id="limpando-dados-de-safras" class="slide level2">
<h2>5.2 Limpando Dados de Safras</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a></a><span class="co"># Conectar aos dados Bronze</span></span>
<span id="cb12-2"><a></a>con_bronze <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb12-3"><a></a>  bigrquery<span class="sc">::</span><span class="fu">bigquery</span>(),</span>
<span id="cb12-4"><a></a>  <span class="at">project =</span> project_id,</span>
<span id="cb12-5"><a></a>  <span class="at">dataset =</span> <span class="st">"bronze"</span>,</span>
<span id="cb12-6"><a></a>  <span class="at">billing =</span> project_id</span>
<span id="cb12-7"><a></a>)</span>
<span id="cb12-8"><a></a></span>
<span id="cb12-9"><a></a><span class="co"># Criar vers√£o limpa com dplyr/dbplyr</span></span>
<span id="cb12-10"><a></a>safras_cleaned <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_bronze, <span class="st">"raw_safras"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-11"><a></a>  </span>
<span id="cb12-12"><a></a>  <span class="co"># Padronizar nomes de fazendas</span></span>
<span id="cb12-13"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-14"><a></a>    <span class="at">fazenda =</span> <span class="fu">case_when</span>(</span>
<span id="cb12-15"><a></a>      fazenda <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"Faz A"</span>, <span class="st">"FazendaA"</span>) <span class="sc">~</span> <span class="st">"Fazenda A"</span>,</span>
<span id="cb12-16"><a></a>      <span class="cn">TRUE</span> <span class="sc">~</span> fazenda</span>
<span id="cb12-17"><a></a>    )</span>
<span id="cb12-18"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb12-19"><a></a>  </span>
<span id="cb12-20"><a></a>  <span class="co"># Filtrar datas v√°lidas (√∫ltimos 2 anos)</span></span>
<span id="cb12-21"><a></a>  <span class="fu">filter</span>(data_plantio <span class="sc">&gt;=</span> <span class="st">"2022-01-01"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-22"><a></a>  <span class="fu">filter</span>(data_plantio <span class="sc">&lt;=</span> <span class="st">"2024-12-31"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-23"><a></a>  </span>
<span id="cb12-24"><a></a>  <span class="co"># Remover registros sem √°rea (inv√°lidos)</span></span>
<span id="cb12-25"><a></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(area_ha)) <span class="sc">%&gt;%</span></span>
<span id="cb12-26"><a></a>  <span class="fu">filter</span>(area_ha <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-27"><a></a>  </span>
<span id="cb12-28"><a></a>  <span class="co"># Adicionar colunas calculadas</span></span>
<span id="cb12-29"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-30"><a></a>    <span class="at">ano_safra =</span> <span class="fu">year</span>(data_plantio),</span>
<span id="cb12-31"><a></a>    <span class="at">mes_plantio =</span> <span class="fu">month</span>(data_plantio),</span>
<span id="cb12-32"><a></a>    <span class="at">produtividade_ton_ha =</span> producao_ton <span class="sc">/</span> area_ha</span>
<span id="cb12-33"><a></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="salvando-no-silver" class="slide level2">
<h2>5.3 Salvando no Silver</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a></a><span class="co"># Materializar resultado no Silver</span></span>
<span id="cb13-2"><a></a>safras_cleaned <span class="sc">%&gt;%</span></span>
<span id="cb13-3"><a></a>  <span class="fu">compute</span>(</span>
<span id="cb13-4"><a></a>    <span class="at">name =</span> <span class="st">"safras_cleaned"</span>,</span>
<span id="cb13-5"><a></a>    <span class="at">temporary =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-6"><a></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb13-7"><a></a>  )</span>
<span id="cb13-8"><a></a></span>
<span id="cb13-9"><a></a><span class="co"># OU usando bq_table_upload ap√≥s collect():</span></span>
<span id="cb13-10"><a></a>safras_cleaned_local <span class="ot">&lt;-</span> safras_cleaned <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb13-11"><a></a></span>
<span id="cb13-12"><a></a><span class="fu">bq_table_upload</span>(</span>
<span id="cb13-13"><a></a>  <span class="at">x =</span> <span class="fu">bq_table</span>(project_id, <span class="st">"silver"</span>, <span class="st">"safras_cleaned"</span>),</span>
<span id="cb13-14"><a></a>  <span class="at">values =</span> safras_cleaned_local,</span>
<span id="cb13-15"><a></a>  <span class="at">fields =</span> <span class="fu">as_bq_fields</span>(safras_cleaned_local),</span>
<span id="cb13-16"><a></a>  <span class="at">write_disposition =</span> <span class="st">"WRITE_TRUNCATE"</span></span>
<span id="cb13-17"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="limpando-dados-clim√°ticos" class="slide level2">
<h2>5.4 Limpando Dados Clim√°ticos</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a></a>clima_validated <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_bronze, <span class="st">"raw_clima"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a></a>  </span>
<span id="cb14-3"><a></a>  <span class="co"># Validar temperaturas (l√≥gica: min &lt; max)</span></span>
<span id="cb14-4"><a></a>  <span class="fu">filter</span>(temp_min <span class="sc">&lt;</span> temp_max) <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a></a>  <span class="fu">filter</span>(temp_max <span class="sc">&lt;</span> <span class="dv">50</span>) <span class="sc">%&gt;%</span>  <span class="co"># valores realistas</span></span>
<span id="cb14-6"><a></a>  <span class="fu">filter</span>(temp_min <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a></a>  </span>
<span id="cb14-8"><a></a>  <span class="co"># Validar precipita√ß√£o</span></span>
<span id="cb14-9"><a></a>  <span class="fu">filter</span>(precipitacao_mm <span class="sc">&gt;=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a></a>  <span class="fu">filter</span>(precipitacao_mm <span class="sc">&lt;</span> <span class="dv">300</span>) <span class="sc">%&gt;%</span>  <span class="co"># 300mm/dia √© extremo</span></span>
<span id="cb14-11"><a></a>  </span>
<span id="cb14-12"><a></a>  <span class="co"># Validar umidade</span></span>
<span id="cb14-13"><a></a>  <span class="fu">filter</span>(umidade <span class="sc">&gt;=</span> <span class="dv">0</span> <span class="sc">&amp;</span> umidade <span class="sc">&lt;=</span> <span class="dv">100</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a></a>  </span>
<span id="cb14-15"><a></a>  <span class="co"># Criar indicadores</span></span>
<span id="cb14-16"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-17"><a></a>    <span class="at">amplitude_termica =</span> temp_max <span class="sc">-</span> temp_min,</span>
<span id="cb14-18"><a></a>    <span class="at">choveu =</span> <span class="fu">if_else</span>(precipitacao_mm <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb14-19"><a></a>    <span class="at">periodo =</span> <span class="fu">case_when</span>(</span>
<span id="cb14-20"><a></a>      <span class="fu">month</span>(data) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">~</span> <span class="st">"Ver√£o"</span>,</span>
<span id="cb14-21"><a></a>      <span class="fu">month</span>(data) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>) <span class="sc">~</span> <span class="st">"Outono"</span>,</span>
<span id="cb14-22"><a></a>      <span class="fu">month</span>(data) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>) <span class="sc">~</span> <span class="st">"Inverno"</span>,</span>
<span id="cb14-23"><a></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Primavera"</span></span>
<span id="cb14-24"><a></a>    )</span>
<span id="cb14-25"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-26"><a></a>  </span>
<span id="cb14-27"><a></a>  <span class="co"># Ordenar</span></span>
<span id="cb14-28"><a></a>  <span class="fu">arrange</span>(fazenda, data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="enriquecendo-dados-de-insumos" class="slide level2">
<h2>5.5 Enriquecendo Dados de Insumos</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a></a>insumos_enriched <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_bronze, <span class="st">"raw_insumos"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a></a>  </span>
<span id="cb15-3"><a></a>  <span class="co"># Calcular custo por kg</span></span>
<span id="cb15-4"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-5"><a></a>    <span class="at">custo_por_kg =</span> custo_total <span class="sc">/</span> quantidade_kg</span>
<span id="cb15-6"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-7"><a></a>  </span>
<span id="cb15-8"><a></a>  <span class="co"># Categorizar custos</span></span>
<span id="cb15-9"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-10"><a></a>    <span class="at">categoria_custo =</span> <span class="fu">case_when</span>(</span>
<span id="cb15-11"><a></a>      custo_por_kg <span class="sc">&lt;</span> <span class="dv">10</span> <span class="sc">~</span> <span class="st">"Baixo"</span>,</span>
<span id="cb15-12"><a></a>      custo_por_kg <span class="sc">&lt;</span> <span class="dv">30</span> <span class="sc">~</span> <span class="st">"M√©dio"</span>,</span>
<span id="cb15-13"><a></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"Alto"</span></span>
<span id="cb15-14"><a></a>    )</span>
<span id="cb15-15"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-16"><a></a>  </span>
<span id="cb15-17"><a></a>  <span class="co"># Adicionar informa√ß√µes temporais</span></span>
<span id="cb15-18"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-19"><a></a>    <span class="at">ano =</span> <span class="fu">year</span>(data_aplicacao),</span>
<span id="cb15-20"><a></a>    <span class="at">trimestre =</span> <span class="fu">quarter</span>(data_aplicacao),</span>
<span id="cb15-21"><a></a>    <span class="at">mes =</span> <span class="fu">month</span>(data_aplicacao)</span>
<span id="cb15-22"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-23"><a></a>  </span>
<span id="cb15-24"><a></a>  <span class="co"># Validar valores</span></span>
<span id="cb15-25"><a></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(quantidade_kg)) <span class="sc">%&gt;%</span></span>
<span id="cb15-26"><a></a>  <span class="fu">filter</span>(quantidade_kg <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-27"><a></a>  <span class="fu">filter</span>(custo_total <span class="sc">&gt;</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="salvando-todas-as-tabelas-silver" class="slide level2">
<h2>5.6 Salvando Todas as Tabelas Silver</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a></a><span class="co"># Salvar clima validado</span></span>
<span id="cb16-2"><a></a>clima_validated <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a></a>  <span class="fu">compute</span>(</span>
<span id="cb16-4"><a></a>    <span class="at">name =</span> <span class="st">"clima_validated"</span>,</span>
<span id="cb16-5"><a></a>    <span class="at">temporary =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-6"><a></a>    <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb16-7"><a></a>  )</span>
<span id="cb16-8"><a></a></span>
<span id="cb16-9"><a></a><span class="co"># Salvar insumos enriquecidos</span></span>
<span id="cb16-10"><a></a>insumos_enriched_local <span class="ot">&lt;-</span> insumos_enriched <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb16-11"><a></a></span>
<span id="cb16-12"><a></a><span class="fu">bq_table_upload</span>(</span>
<span id="cb16-13"><a></a>  <span class="at">x =</span> <span class="fu">bq_table</span>(project_id, <span class="st">"silver"</span>, <span class="st">"insumos_enriched"</span>),</span>
<span id="cb16-14"><a></a>  <span class="at">values =</span> insumos_enriched_local,</span>
<span id="cb16-15"><a></a>  <span class="at">write_disposition =</span> <span class="st">"WRITE_TRUNCATE"</span></span>
<span id="cb16-16"><a></a>)</span>
<span id="cb16-17"><a></a></span>
<span id="cb16-18"><a></a><span class="co"># Verificar tabelas criadas no Silver</span></span>
<span id="cb16-19"><a></a>con_silver <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb16-20"><a></a>  bigrquery<span class="sc">::</span><span class="fu">bigquery</span>(),</span>
<span id="cb16-21"><a></a>  <span class="at">project =</span> project_id,</span>
<span id="cb16-22"><a></a>  <span class="at">dataset =</span> <span class="st">"silver"</span>,</span>
<span id="cb16-23"><a></a>  <span class="at">billing =</span> project_id</span>
<span id="cb16-24"><a></a>)</span>
<span id="cb16-25"><a></a></span>
<span id="cb16-26"><a></a><span class="fu">dbListTables</span>(con_silver)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="camada-gold---agrega√ß√µes" class="title-slide slide level1 center" data-background-color="#FFD700">
<h1>6. Camada Gold - Agrega√ß√µes</h1>

</section>
<section id="estrat√©gia-gold" class="slide level2">
<h2>6.1 Estrat√©gia Gold</h2>
<p><strong>Camada Gold = An√°lises prontas para neg√≥cio</strong></p>
<p><strong>Caracter√≠sticas:</strong></p>
<ul>
<li>Agrega√ß√µes pr√©-calculadas</li>
<li>M√©tricas de neg√≥cio</li>
<li>Dados desnormalizados (joins prontos)</li>
<li>Otimizado para visualiza√ß√£o</li>
<li>R√°pido para consultar</li>
</ul>
<p><strong>Nosso objetivo:</strong> An√°lises de rentabilidade por cultura e fazenda</p>
</section>
<section id="agrega√ß√£o-produ√ß√£o-por-fazenda" class="slide level2">
<h2>6.2 Agrega√ß√£o: Produ√ß√£o por Fazenda</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a></a>con_silver <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb17-2"><a></a>  bigrquery<span class="sc">::</span><span class="fu">bigquery</span>(),</span>
<span id="cb17-3"><a></a>  <span class="at">project =</span> project_id,</span>
<span id="cb17-4"><a></a>  <span class="at">dataset =</span> <span class="st">"silver"</span>,</span>
<span id="cb17-5"><a></a>  <span class="at">billing =</span> project_id</span>
<span id="cb17-6"><a></a>)</span>
<span id="cb17-7"><a></a></span>
<span id="cb17-8"><a></a>agg_producao_fazenda <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_silver, <span class="st">"safras_cleaned"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-9"><a></a>  </span>
<span id="cb17-10"><a></a>  <span class="co"># Apenas safras colhidas</span></span>
<span id="cb17-11"><a></a>  <span class="fu">filter</span>(status <span class="sc">==</span> <span class="st">"Colhido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-12"><a></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(producao_ton)) <span class="sc">%&gt;%</span></span>
<span id="cb17-13"><a></a>  </span>
<span id="cb17-14"><a></a>  <span class="co"># Agrupar</span></span>
<span id="cb17-15"><a></a>  <span class="fu">group_by</span>(fazenda, cultura, ano_safra) <span class="sc">%&gt;%</span></span>
<span id="cb17-16"><a></a>  </span>
<span id="cb17-17"><a></a>  <span class="co"># Agregar</span></span>
<span id="cb17-18"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb17-19"><a></a>    <span class="at">total_area_ha =</span> <span class="fu">sum</span>(area_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-20"><a></a>    <span class="at">total_producao_ton =</span> <span class="fu">sum</span>(producao_ton, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-21"><a></a>    <span class="at">producao_media_ton =</span> <span class="fu">mean</span>(producao_ton, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-22"><a></a>    <span class="at">produtividade_media =</span> <span class="fu">mean</span>(produtividade_ton_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb17-23"><a></a>    <span class="at">numero_safras =</span> <span class="fu">n</span>(),</span>
<span id="cb17-24"><a></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb17-25"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-26"><a></a>  </span>
<span id="cb17-27"><a></a>  <span class="co"># Adicionar ranking</span></span>
<span id="cb17-28"><a></a>  <span class="fu">group_by</span>(ano_safra) <span class="sc">%&gt;%</span></span>
<span id="cb17-29"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-30"><a></a>    <span class="at">rank_producao =</span> <span class="fu">rank</span>(<span class="fu">desc</span>(total_producao_ton))</span>
<span id="cb17-31"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-32"><a></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="agrega√ß√£o-an√°lise-clim√°tica" class="slide level2">
<h2>6.3 Agrega√ß√£o: An√°lise Clim√°tica</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a></a>agg_clima_mensal <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_silver, <span class="st">"clima_validated"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a></a>  </span>
<span id="cb18-3"><a></a>  <span class="co"># Criar per√≠odo mensal</span></span>
<span id="cb18-4"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-5"><a></a>    <span class="at">ano =</span> <span class="fu">year</span>(data),</span>
<span id="cb18-6"><a></a>    <span class="at">mes =</span> <span class="fu">month</span>(data)</span>
<span id="cb18-7"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-8"><a></a>  </span>
<span id="cb18-9"><a></a>  <span class="co"># Agrupar</span></span>
<span id="cb18-10"><a></a>  <span class="fu">group_by</span>(fazenda, ano, mes) <span class="sc">%&gt;%</span></span>
<span id="cb18-11"><a></a>  </span>
<span id="cb18-12"><a></a>  <span class="co"># Calcular estat√≠sticas</span></span>
<span id="cb18-13"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb18-14"><a></a>    <span class="at">temp_max_media =</span> <span class="fu">mean</span>(temp_max, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-15"><a></a>    <span class="at">temp_min_media =</span> <span class="fu">mean</span>(temp_min, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-16"><a></a>    <span class="at">temp_amplitude_media =</span> <span class="fu">mean</span>(amplitude_termica, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-17"><a></a>    <span class="at">precipitacao_total =</span> <span class="fu">sum</span>(precipitacao_mm, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-18"><a></a>    <span class="at">dias_chuva =</span> <span class="fu">sum</span>(choveu, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-19"><a></a>    <span class="at">umidade_media =</span> <span class="fu">mean</span>(umidade, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb18-20"><a></a>    <span class="at">dias_registrados =</span> <span class="fu">n</span>(),</span>
<span id="cb18-21"><a></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb18-22"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-23"><a></a>  </span>
<span id="cb18-24"><a></a>  <span class="co"># Adicionar categorias</span></span>
<span id="cb18-25"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb18-26"><a></a>    <span class="at">mes_nome =</span> <span class="fu">case_when</span>(</span>
<span id="cb18-27"><a></a>      mes <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"Janeiro"</span>, mes <span class="sc">==</span> <span class="dv">2</span> <span class="sc">~</span> <span class="st">"Fevereiro"</span>,</span>
<span id="cb18-28"><a></a>      mes <span class="sc">==</span> <span class="dv">3</span> <span class="sc">~</span> <span class="st">"Mar√ßo"</span>, mes <span class="sc">==</span> <span class="dv">4</span> <span class="sc">~</span> <span class="st">"Abril"</span>,</span>
<span id="cb18-29"><a></a>      mes <span class="sc">==</span> <span class="dv">5</span> <span class="sc">~</span> <span class="st">"Maio"</span>, mes <span class="sc">==</span> <span class="dv">6</span> <span class="sc">~</span> <span class="st">"Junho"</span>,</span>
<span id="cb18-30"><a></a>      mes <span class="sc">==</span> <span class="dv">7</span> <span class="sc">~</span> <span class="st">"Julho"</span>, mes <span class="sc">==</span> <span class="dv">8</span> <span class="sc">~</span> <span class="st">"Agosto"</span>,</span>
<span id="cb18-31"><a></a>      mes <span class="sc">==</span> <span class="dv">9</span> <span class="sc">~</span> <span class="st">"Setembro"</span>, mes <span class="sc">==</span> <span class="dv">10</span> <span class="sc">~</span> <span class="st">"Outubro"</span>,</span>
<span id="cb18-32"><a></a>      mes <span class="sc">==</span> <span class="dv">11</span> <span class="sc">~</span> <span class="st">"Novembro"</span>, mes <span class="sc">==</span> <span class="dv">12</span> <span class="sc">~</span> <span class="st">"Dezembro"</span></span>
<span id="cb18-33"><a></a>    )</span>
<span id="cb18-34"><a></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="agrega√ß√£o-custos-e-rentabilidade" class="slide level2">
<h2>6.4 Agrega√ß√£o: Custos e Rentabilidade</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a></a><span class="co"># Primeiro, calcular custo total por safra</span></span>
<span id="cb19-2"><a></a>custos_por_safra <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_silver, <span class="st">"insumos_enriched"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a></a>  <span class="fu">group_by</span>(safra_id) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb19-5"><a></a>    <span class="at">custo_total_insumos =</span> <span class="fu">sum</span>(custo_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-6"><a></a>    <span class="at">numero_aplicacoes =</span> <span class="fu">n</span>(),</span>
<span id="cb19-7"><a></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb19-8"><a></a>  )</span>
<span id="cb19-9"><a></a></span>
<span id="cb19-10"><a></a><span class="co"># Agora criar tabela de rentabilidade</span></span>
<span id="cb19-11"><a></a><span class="co"># (assumindo pre√ßo de venda m√©dio por cultura)</span></span>
<span id="cb19-12"><a></a>agg_rentabilidade <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_silver, <span class="st">"safras_cleaned"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-13"><a></a>  </span>
<span id="cb19-14"><a></a>  <span class="fu">filter</span>(status <span class="sc">==</span> <span class="st">"Colhido"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-15"><a></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(producao_ton)) <span class="sc">%&gt;%</span></span>
<span id="cb19-16"><a></a>  </span>
<span id="cb19-17"><a></a>  <span class="co"># Join com custos</span></span>
<span id="cb19-18"><a></a>  <span class="fu">left_join</span>(custos_por_safra, <span class="at">by =</span> <span class="st">"safra_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-19"><a></a>  </span>
<span id="cb19-20"><a></a>  <span class="co"># Adicionar pre√ßos (simulados - em produ√ß√£o viriam de outra tabela)</span></span>
<span id="cb19-21"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-22"><a></a>    <span class="at">preco_ton =</span> <span class="fu">case_when</span>(</span>
<span id="cb19-23"><a></a>      cultura <span class="sc">==</span> <span class="st">"Soja"</span> <span class="sc">~</span> <span class="dv">1800</span>,</span>
<span id="cb19-24"><a></a>      cultura <span class="sc">==</span> <span class="st">"Milho"</span> <span class="sc">~</span> <span class="dv">800</span>,</span>
<span id="cb19-25"><a></a>      cultura <span class="sc">==</span> <span class="st">"Trigo"</span> <span class="sc">~</span> <span class="dv">1200</span>,</span>
<span id="cb19-26"><a></a>      <span class="cn">TRUE</span> <span class="sc">~</span> <span class="dv">1000</span></span>
<span id="cb19-27"><a></a>    )</span>
<span id="cb19-28"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb19-29"><a></a>  </span>
<span id="cb19-30"><a></a>  <span class="co"># Calcular receita e lucro</span></span>
<span id="cb19-31"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-32"><a></a>    <span class="at">receita_total =</span> producao_ton <span class="sc">*</span> preco_ton,</span>
<span id="cb19-33"><a></a>    <span class="at">custo_total =</span> <span class="fu">coalesce</span>(custo_total_insumos, <span class="dv">0</span>),</span>
<span id="cb19-34"><a></a>    <span class="at">lucro_bruto =</span> receita_total <span class="sc">-</span> custo_total,</span>
<span id="cb19-35"><a></a>    <span class="at">margem_lucro_pct =</span> (lucro_bruto <span class="sc">/</span> receita_total) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb19-36"><a></a>    <span class="at">roi =</span> (lucro_bruto <span class="sc">/</span> custo_total) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb19-37"><a></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="vis√£o-consolidada-gold" class="slide level2">
<h2>6.5 Vis√£o Consolidada Gold</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a></a><span class="co"># Criar vis√£o anal√≠tica completa</span></span>
<span id="cb20-2"><a></a>agg_visao_consolidada <span class="ot">&lt;-</span> agg_rentabilidade <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a></a>  </span>
<span id="cb20-4"><a></a>  <span class="fu">group_by</span>(fazenda, cultura, ano_safra) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a></a>  </span>
<span id="cb20-6"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb20-7"><a></a>    <span class="co"># Produ√ß√£o</span></span>
<span id="cb20-8"><a></a>    <span class="at">area_total_ha =</span> <span class="fu">sum</span>(area_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-9"><a></a>    <span class="at">producao_total_ton =</span> <span class="fu">sum</span>(producao_ton, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-10"><a></a>    <span class="at">produtividade_media =</span> <span class="fu">mean</span>(produtividade_ton_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-11"><a></a>    </span>
<span id="cb20-12"><a></a>    <span class="co"># Financeiro</span></span>
<span id="cb20-13"><a></a>    <span class="at">receita_total =</span> <span class="fu">sum</span>(receita_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-14"><a></a>    <span class="at">custo_total =</span> <span class="fu">sum</span>(custo_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-15"><a></a>    <span class="at">lucro_total =</span> <span class="fu">sum</span>(lucro_bruto, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-16"><a></a>    <span class="at">margem_media =</span> <span class="fu">mean</span>(margem_lucro_pct, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-17"><a></a>    </span>
<span id="cb20-18"><a></a>    <span class="co"># Contadores</span></span>
<span id="cb20-19"><a></a>    <span class="at">numero_safras =</span> <span class="fu">n</span>(),</span>
<span id="cb20-20"><a></a>    <span class="at">safras_lucrativas =</span> <span class="fu">sum</span>(lucro_bruto <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-21"><a></a>    </span>
<span id="cb20-22"><a></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb20-23"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-24"><a></a>  </span>
<span id="cb20-25"><a></a>  <span class="co"># M√©tricas adicionais</span></span>
<span id="cb20-26"><a></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-27"><a></a>    <span class="at">receita_por_ha =</span> receita_total <span class="sc">/</span> area_total_ha,</span>
<span id="cb20-28"><a></a>    <span class="at">custo_por_ha =</span> custo_total <span class="sc">/</span> area_total_ha,</span>
<span id="cb20-29"><a></a>    <span class="at">lucro_por_ha =</span> lucro_total <span class="sc">/</span> area_total_ha,</span>
<span id="cb20-30"><a></a>    <span class="at">taxa_sucesso =</span> (safras_lucrativas <span class="sc">/</span> numero_safras) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb20-31"><a></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="salvando-tabelas-gold" class="slide level2">
<h2>6.6 Salvando Tabelas Gold</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a></a><span class="co"># Salvar cada agrega√ß√£o no dataset gold</span></span>
<span id="cb21-2"><a></a></span>
<span id="cb21-3"><a></a><span class="co"># Produ√ß√£o por fazenda</span></span>
<span id="cb21-4"><a></a>agg_producao_fazenda_local <span class="ot">&lt;-</span> agg_producao_fazenda <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb21-5"><a></a><span class="fu">bq_table_upload</span>(</span>
<span id="cb21-6"><a></a>  <span class="at">x =</span> <span class="fu">bq_table</span>(project_id, <span class="st">"gold"</span>, <span class="st">"agg_producao_fazenda"</span>),</span>
<span id="cb21-7"><a></a>  <span class="at">values =</span> agg_producao_fazenda_local,</span>
<span id="cb21-8"><a></a>  <span class="at">write_disposition =</span> <span class="st">"WRITE_TRUNCATE"</span></span>
<span id="cb21-9"><a></a>)</span>
<span id="cb21-10"><a></a></span>
<span id="cb21-11"><a></a><span class="co"># Clima mensal</span></span>
<span id="cb21-12"><a></a>agg_clima_mensal_local <span class="ot">&lt;-</span> agg_clima_mensal <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb21-13"><a></a><span class="fu">bq_table_upload</span>(</span>
<span id="cb21-14"><a></a>  <span class="at">x =</span> <span class="fu">bq_table</span>(project_id, <span class="st">"gold"</span>, <span class="st">"agg_clima_mensal"</span>),</span>
<span id="cb21-15"><a></a>  <span class="at">values =</span> agg_clima_mensal_local,</span>
<span id="cb21-16"><a></a>  <span class="at">write_disposition =</span> <span class="st">"WRITE_TRUNCATE"</span></span>
<span id="cb21-17"><a></a>)</span>
<span id="cb21-18"><a></a></span>
<span id="cb21-19"><a></a><span class="co"># Vis√£o consolidada</span></span>
<span id="cb21-20"><a></a>agg_visao_consolidada_local <span class="ot">&lt;-</span> agg_visao_consolidada <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb21-21"><a></a><span class="fu">bq_table_upload</span>(</span>
<span id="cb21-22"><a></a>  <span class="at">x =</span> <span class="fu">bq_table</span>(project_id, <span class="st">"gold"</span>, <span class="st">"agg_visao_consolidada"</span>),</span>
<span id="cb21-23"><a></a>  <span class="at">values =</span> agg_visao_consolidada_local,</span>
<span id="cb21-24"><a></a>  <span class="at">write_disposition =</span> <span class="st">"WRITE_TRUNCATE"</span></span>
<span id="cb21-25"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="consumo-anal√≠tico-com-r" class="title-slide slide level1 center" data-background-color="#34A853">
<h1>7. Consumo Anal√≠tico com R</h1>

</section>
<section id="conectando-ao-gold" class="slide level2">
<h2>7.1 Conectando ao Gold</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a></a><span class="co"># Conectar diretamente ao dataset Gold</span></span>
<span id="cb22-2"><a></a>con_gold <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb22-3"><a></a>  bigrquery<span class="sc">::</span><span class="fu">bigquery</span>(),</span>
<span id="cb22-4"><a></a>  <span class="at">project =</span> project_id,</span>
<span id="cb22-5"><a></a>  <span class="at">dataset =</span> <span class="st">"gold"</span>,</span>
<span id="cb22-6"><a></a>  <span class="at">billing =</span> project_id</span>
<span id="cb22-7"><a></a>)</span>
<span id="cb22-8"><a></a></span>
<span id="cb22-9"><a></a><span class="co"># Listar tabelas dispon√≠veis</span></span>
<span id="cb22-10"><a></a><span class="fu">dbListTables</span>(con_gold)</span>
<span id="cb22-11"><a></a></span>
<span id="cb22-12"><a></a><span class="co"># Criar refer√™ncia √†s tabelas</span></span>
<span id="cb22-13"><a></a>visao_consolidada <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_gold, <span class="st">"agg_visao_consolidada"</span>)</span>
<span id="cb22-14"><a></a>producao_fazenda <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_gold, <span class="st">"agg_producao_fazenda"</span>)</span>
<span id="cb22-15"><a></a>clima_mensal <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_gold, <span class="st">"agg_clima_mensal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="an√°lise-explorat√≥ria-com-dplyr" class="slide level2">
<h2>7.2 An√°lise Explorat√≥ria com dplyr</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a></a><span class="co"># Top 5 fazendas mais lucrativas</span></span>
<span id="cb23-2"><a></a>top_fazendas <span class="ot">&lt;-</span> visao_consolidada <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a></a>  <span class="fu">group_by</span>(fazenda) <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb23-5"><a></a>    <span class="at">lucro_total =</span> <span class="fu">sum</span>(lucro_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-6"><a></a>    <span class="at">area_total =</span> <span class="fu">sum</span>(area_total_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-7"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(lucro_total)) <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a></a>  <span class="fu">head</span>(<span class="dv">5</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-10"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb23-11"><a></a></span>
<span id="cb23-12"><a></a><span class="fu">print</span>(top_fazendas)</span>
<span id="cb23-13"><a></a></span>
<span id="cb23-14"><a></a><span class="co"># Cultura mais rent√°vel</span></span>
<span id="cb23-15"><a></a>melhor_cultura <span class="ot">&lt;-</span> visao_consolidada <span class="sc">%&gt;%</span></span>
<span id="cb23-16"><a></a>  <span class="fu">group_by</span>(cultura) <span class="sc">%&gt;%</span></span>
<span id="cb23-17"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb23-18"><a></a>    <span class="at">margem_media =</span> <span class="fu">mean</span>(margem_media, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb23-19"><a></a>    <span class="at">lucro_por_ha =</span> <span class="fu">mean</span>(lucro_por_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-20"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb23-21"><a></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(margem_media)) <span class="sc">%&gt;%</span></span>
<span id="cb23-22"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb23-23"><a></a></span>
<span id="cb23-24"><a></a><span class="fu">print</span>(melhor_cultura)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualiza√ß√µes-com-ggplot2" class="slide level2">
<h2>7.3 Visualiza√ß√µes com ggplot2</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb24-2"><a></a></span>
<span id="cb24-3"><a></a><span class="co"># Produ√ß√£o por cultura ao longo do tempo</span></span>
<span id="cb24-4"><a></a>producao_tempo <span class="ot">&lt;-</span> visao_consolidada <span class="sc">%&gt;%</span></span>
<span id="cb24-5"><a></a>  <span class="fu">group_by</span>(ano_safra, cultura) <span class="sc">%&gt;%</span></span>
<span id="cb24-6"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb24-7"><a></a>    <span class="at">producao_total =</span> <span class="fu">sum</span>(producao_total_ton, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb24-8"><a></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb24-9"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb24-10"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb24-11"><a></a></span>
<span id="cb24-12"><a></a><span class="fu">ggplot</span>(producao_tempo, <span class="fu">aes</span>(<span class="at">x =</span> ano_safra, <span class="at">y =</span> producao_total, </span>
<span id="cb24-13"><a></a>                            <span class="at">color =</span> cultura, <span class="at">group =</span> cultura)) <span class="sc">+</span></span>
<span id="cb24-14"><a></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.2</span>) <span class="sc">+</span></span>
<span id="cb24-15"><a></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb24-16"><a></a>  <span class="fu">labs</span>(</span>
<span id="cb24-17"><a></a>    <span class="at">title =</span> <span class="st">"Evolu√ß√£o da Produ√ß√£o por Cultura"</span>,</span>
<span id="cb24-18"><a></a>    <span class="at">x =</span> <span class="st">"Ano Safra"</span>,</span>
<span id="cb24-19"><a></a>    <span class="at">y =</span> <span class="st">"Produ√ß√£o Total (toneladas)"</span>,</span>
<span id="cb24-20"><a></a>    <span class="at">color =</span> <span class="st">"Cultura"</span></span>
<span id="cb24-21"><a></a>  ) <span class="sc">+</span></span>
<span id="cb24-22"><a></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb24-23"><a></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#4285F4"</span>, <span class="st">"#34A853"</span>, <span class="st">"#FBBC04"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="an√°lise-de-rentabilidade" class="slide level2">
<h2>7.4 An√°lise de Rentabilidade</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a></a><span class="co"># Compara√ß√£o de rentabilidade</span></span>
<span id="cb25-2"><a></a>rentabilidade <span class="ot">&lt;-</span> visao_consolidada <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a></a>  <span class="fu">filter</span>(ano_safra <span class="sc">==</span> <span class="dv">2023</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb25-5"><a></a></span>
<span id="cb25-6"><a></a><span class="fu">ggplot</span>(rentabilidade, <span class="fu">aes</span>(<span class="at">x =</span> cultura, <span class="at">y =</span> lucro_por_ha, </span>
<span id="cb25-7"><a></a>                           <span class="at">fill =</span> fazenda)) <span class="sc">+</span></span>
<span id="cb25-8"><a></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb25-9"><a></a>  <span class="fu">labs</span>(</span>
<span id="cb25-10"><a></a>    <span class="at">title =</span> <span class="st">"Lucro por Hectare - Safra 2023"</span>,</span>
<span id="cb25-11"><a></a>    <span class="at">x =</span> <span class="st">"Cultura"</span>,</span>
<span id="cb25-12"><a></a>    <span class="at">y =</span> <span class="st">"Lucro (R$/ha)"</span>,</span>
<span id="cb25-13"><a></a>    <span class="at">fill =</span> <span class="st">"Fazenda"</span></span>
<span id="cb25-14"><a></a>  ) <span class="sc">+</span></span>
<span id="cb25-15"><a></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb25-16"><a></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="an√°lise-clim√°tica-e-produtividade" class="slide level2">
<h2>7.5 An√°lise Clim√°tica e Produtividade</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a></a><span class="co"># Correla√ß√£o clima x produtividade</span></span>
<span id="cb26-2"><a></a><span class="co"># Juntar dados de clima com produ√ß√£o</span></span>
<span id="cb26-3"><a></a>clima_prod <span class="ot">&lt;-</span> producao_fazenda <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a></a>  <span class="fu">filter</span>(ano_safra <span class="sc">==</span> <span class="dv">2023</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a></a>  <span class="fu">select</span>(fazenda, cultura, produtividade_media) <span class="sc">%&gt;%</span></span>
<span id="cb26-6"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb26-7"><a></a></span>
<span id="cb26-8"><a></a>clima_resumo <span class="ot">&lt;-</span> clima_mensal <span class="sc">%&gt;%</span></span>
<span id="cb26-9"><a></a>  <span class="fu">filter</span>(ano <span class="sc">==</span> <span class="dv">2023</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-10"><a></a>  <span class="fu">group_by</span>(fazenda) <span class="sc">%&gt;%</span></span>
<span id="cb26-11"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb26-12"><a></a>    <span class="at">precipitacao_anual =</span> <span class="fu">sum</span>(precipitacao_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb26-13"><a></a>    <span class="at">temp_media_anual =</span> <span class="fu">mean</span>(temp_max_media, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-14"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb26-15"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb26-16"><a></a></span>
<span id="cb26-17"><a></a>analise_clima <span class="ot">&lt;-</span> clima_prod <span class="sc">%&gt;%</span></span>
<span id="cb26-18"><a></a>  <span class="fu">left_join</span>(clima_resumo, <span class="at">by =</span> <span class="st">"fazenda"</span>)</span>
<span id="cb26-19"><a></a></span>
<span id="cb26-20"><a></a><span class="fu">ggplot</span>(analise_clima, <span class="fu">aes</span>(<span class="at">x =</span> precipitacao_anual, </span>
<span id="cb26-21"><a></a>                           <span class="at">y =</span> produtividade_media, </span>
<span id="cb26-22"><a></a>                           <span class="at">color =</span> cultura)) <span class="sc">+</span></span>
<span id="cb26-23"><a></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb26-24"><a></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb26-25"><a></a>  <span class="fu">labs</span>(</span>
<span id="cb26-26"><a></a>    <span class="at">title =</span> <span class="st">"Rela√ß√£o Precipita√ß√£o vs Produtividade"</span>,</span>
<span id="cb26-27"><a></a>    <span class="at">x =</span> <span class="st">"Precipita√ß√£o Anual (mm)"</span>,</span>
<span id="cb26-28"><a></a>    <span class="at">y =</span> <span class="st">"Produtividade (ton/ha)"</span></span>
<span id="cb26-29"><a></a>  ) <span class="sc">+</span></span>
<span id="cb26-30"><a></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="query-sql-direta-quando-necess√°rio" class="slide level2">
<h2>7.6 Query SQL Direta (quando necess√°rio)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a></a><span class="co"># Para queries muito complexas, pode usar SQL direto</span></span>
<span id="cb27-2"><a></a>query_complexa <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb27-3"><a></a><span class="st">  SELECT </span></span>
<span id="cb27-4"><a></a><span class="st">    fazenda,</span></span>
<span id="cb27-5"><a></a><span class="st">    cultura,</span></span>
<span id="cb27-6"><a></a><span class="st">    AVG(margem_media) as margem_avg,</span></span>
<span id="cb27-7"><a></a><span class="st">    SUM(lucro_total) as lucro_total,</span></span>
<span id="cb27-8"><a></a><span class="st">    SUM(area_total_ha) as area_total,</span></span>
<span id="cb27-9"><a></a><span class="st">    COUNT(*) as num_registros</span></span>
<span id="cb27-10"><a></a><span class="st">  FROM `datalake-agricola.gold.agg_visao_consolidada`</span></span>
<span id="cb27-11"><a></a><span class="st">  WHERE ano_safra &gt;= 2022</span></span>
<span id="cb27-12"><a></a><span class="st">  GROUP BY fazenda, cultura</span></span>
<span id="cb27-13"><a></a><span class="st">  HAVING lucro_total &gt; 0</span></span>
<span id="cb27-14"><a></a><span class="st">  ORDER BY margem_avg DESC</span></span>
<span id="cb27-15"><a></a><span class="st">"</span></span>
<span id="cb27-16"><a></a></span>
<span id="cb27-17"><a></a>resultado <span class="ot">&lt;-</span> <span class="fu">bq_project_query</span>(project_id, query_complexa)</span>
<span id="cb27-18"><a></a>dados_query <span class="ot">&lt;-</span> <span class="fu">bq_table_download</span>(resultado)</span>
<span id="cb27-19"><a></a></span>
<span id="cb27-20"><a></a><span class="fu">print</span>(dados_query)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="relat√≥rio-reprodut√≠vel" class="title-slide slide level1 center" data-background-color="#FBBC04">
<h1>8. Relat√≥rio Reprodut√≠vel</h1>

</section>
<section id="estrutura-do-relat√≥rio-quarto" class="slide level2">
<h2>8.1 Estrutura do Relat√≥rio Quarto</h2>
<p><strong>Criar arquivo <code>relatorio_datalake.qmd</code>:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a></a><span class="co"># ---</span></span>
<span id="cb28-2"><a></a><span class="co"># title: "Relat√≥rio de An√°lise Agr√≠cola"</span></span>
<span id="cb28-3"><a></a><span class="co"># subtitle: "Data Lake GCP - Safra 2023"</span></span>
<span id="cb28-4"><a></a><span class="co"># author: "Seu Nome"</span></span>
<span id="cb28-5"><a></a><span class="co"># date: today</span></span>
<span id="cb28-6"><a></a><span class="co"># format:</span></span>
<span id="cb28-7"><a></a><span class="co">#   html:</span></span>
<span id="cb28-8"><a></a><span class="co">#     toc: true</span></span>
<span id="cb28-9"><a></a><span class="co">#     code-fold: true</span></span>
<span id="cb28-10"><a></a><span class="co">#     theme: cosmo</span></span>
<span id="cb28-11"><a></a><span class="co">#   pdf:</span></span>
<span id="cb28-12"><a></a><span class="co">#     toc: true</span></span>
<span id="cb28-13"><a></a><span class="co"># ---</span></span>
<span id="cb28-14"><a></a></span>
<span id="cb28-15"><a></a><span class="do">## Setup</span></span>
<span id="cb28-16"><a></a><span class="fu">library</span>(bigrquery)</span>
<span id="cb28-17"><a></a><span class="fu">library</span>(DBI)</span>
<span id="cb28-18"><a></a><span class="fu">library</span>(dplyr)</span>
<span id="cb28-19"><a></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb28-20"><a></a><span class="fu">library</span>(knitr)</span>
<span id="cb28-21"><a></a><span class="fu">library</span>(gt)</span>
<span id="cb28-22"><a></a></span>
<span id="cb28-23"><a></a><span class="co"># Conectar</span></span>
<span id="cb28-24"><a></a>project_id <span class="ot">&lt;-</span> <span class="st">"datalake-agricola"</span></span>
<span id="cb28-25"><a></a>con_gold <span class="ot">&lt;-</span> <span class="fu">dbConnect</span>(</span>
<span id="cb28-26"><a></a>  bigrquery<span class="sc">::</span><span class="fu">bigquery</span>(),</span>
<span id="cb28-27"><a></a>  <span class="at">project =</span> project_id,</span>
<span id="cb28-28"><a></a>  <span class="at">dataset =</span> <span class="st">"gold"</span>,</span>
<span id="cb28-29"><a></a>  <span class="at">billing =</span> project_id</span>
<span id="cb28-30"><a></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="se√ß√µes-do-relat√≥rio" class="slide level2">
<h2>8.2 Se√ß√µes do Relat√≥rio</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a></a><span class="co"># ## 1. Resumo Executivo</span></span>
<span id="cb29-2"><a></a>visao_geral <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_gold, <span class="st">"agg_visao_consolidada"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb29-4"><a></a>    <span class="at">area_total =</span> <span class="fu">sum</span>(area_total_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-5"><a></a>    <span class="at">producao_total =</span> <span class="fu">sum</span>(producao_total_ton, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-6"><a></a>    <span class="at">receita_total =</span> <span class="fu">sum</span>(receita_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-7"><a></a>    <span class="at">lucro_total =</span> <span class="fu">sum</span>(lucro_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-8"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb29-9"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb29-10"><a></a></span>
<span id="cb29-11"><a></a><span class="co"># Criar tabela formatada</span></span>
<span id="cb29-12"><a></a>visao_geral <span class="sc">%&gt;%</span></span>
<span id="cb29-13"><a></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-14"><a></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">everything</span>(), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-15"><a></a>  <span class="fu">tab_header</span>(</span>
<span id="cb29-16"><a></a>    <span class="at">title =</span> <span class="st">"Resumo Geral das Opera√ß√µes"</span></span>
<span id="cb29-17"><a></a>  )</span>
<span id="cb29-18"><a></a></span>
<span id="cb29-19"><a></a><span class="co"># ## 2. An√°lise por Cultura</span></span>
<span id="cb29-20"><a></a><span class="co"># ... an√°lises espec√≠ficas</span></span>
<span id="cb29-21"><a></a></span>
<span id="cb29-22"><a></a><span class="co"># ## 3. Desempenho por Fazenda</span></span>
<span id="cb29-23"><a></a><span class="co"># ... compara√ß√µes</span></span>
<span id="cb29-24"><a></a></span>
<span id="cb29-25"><a></a><span class="co"># ## 4. An√°lise Clim√°tica</span></span>
<span id="cb29-26"><a></a><span class="co"># ... impactos do clima</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="tabelas-elegantes-com-gt" class="slide level2">
<h2>8.3 Tabelas Elegantes com gt</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a></a><span class="fu">library</span>(gt)</span>
<span id="cb30-2"><a></a></span>
<span id="cb30-3"><a></a><span class="co"># Criar ranking de fazendas</span></span>
<span id="cb30-4"><a></a>ranking_fazendas <span class="ot">&lt;-</span> <span class="fu">tbl</span>(con_gold, <span class="st">"agg_visao_consolidada"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-5"><a></a>  <span class="fu">filter</span>(ano_safra <span class="sc">==</span> <span class="dv">2023</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a></a>  <span class="fu">group_by</span>(fazenda) <span class="sc">%&gt;%</span></span>
<span id="cb30-7"><a></a>  <span class="fu">summarise</span>(</span>
<span id="cb30-8"><a></a>    <span class="at">area =</span> <span class="fu">sum</span>(area_total_ha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-9"><a></a>    <span class="at">producao =</span> <span class="fu">sum</span>(producao_total_ton, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-10"><a></a>    <span class="at">receita =</span> <span class="fu">sum</span>(receita_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-11"><a></a>    <span class="at">lucro =</span> <span class="fu">sum</span>(lucro_total, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-12"><a></a>    <span class="at">margem =</span> <span class="fu">mean</span>(margem_media, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-13"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-14"><a></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(lucro)) <span class="sc">%&gt;%</span></span>
<span id="cb30-15"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb30-16"><a></a></span>
<span id="cb30-17"><a></a>ranking_fazendas <span class="sc">%&gt;%</span></span>
<span id="cb30-18"><a></a>  <span class="fu">gt</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-19"><a></a>  <span class="fu">cols_label</span>(</span>
<span id="cb30-20"><a></a>    <span class="at">fazenda =</span> <span class="st">"Fazenda"</span>,</span>
<span id="cb30-21"><a></a>    <span class="at">area =</span> <span class="st">"√Årea (ha)"</span>,</span>
<span id="cb30-22"><a></a>    <span class="at">producao =</span> <span class="st">"Produ√ß√£o (ton)"</span>,</span>
<span id="cb30-23"><a></a>    <span class="at">receita =</span> <span class="st">"Receita (R$)"</span>,</span>
<span id="cb30-24"><a></a>    <span class="at">lucro =</span> <span class="st">"Lucro (R$)"</span>,</span>
<span id="cb30-25"><a></a>    <span class="at">margem =</span> <span class="st">"Margem (%)"</span></span>
<span id="cb30-26"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-27"><a></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(area, producao, receita, lucro), </span>
<span id="cb30-28"><a></a>             <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-29"><a></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> margem, <span class="at">decimals =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-30"><a></a>  <span class="fu">data_color</span>(</span>
<span id="cb30-31"><a></a>    <span class="at">columns =</span> margem,</span>
<span id="cb30-32"><a></a>    <span class="at">colors =</span> scales<span class="sc">::</span><span class="fu">col_numeric</span>(</span>
<span id="cb30-33"><a></a>      <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"yellow"</span>, <span class="st">"green"</span>),</span>
<span id="cb30-34"><a></a>      <span class="at">domain =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(ranking_fazendas<span class="sc">$</span>margem))</span>
<span id="cb30-35"><a></a>    )</span>
<span id="cb30-36"><a></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-37"><a></a>  <span class="fu">tab_header</span>(</span>
<span id="cb30-38"><a></a>    <span class="at">title =</span> <span class="st">"Ranking de Desempenho - Safra 2023"</span></span>
<span id="cb30-39"><a></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="gr√°ficos-interativos-com-plotly" class="slide level2">
<h2>8.4 Gr√°ficos Interativos com plotly</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a></a><span class="fu">library</span>(plotly)</span>
<span id="cb31-2"><a></a></span>
<span id="cb31-3"><a></a><span class="co"># Criar gr√°fico base</span></span>
<span id="cb31-4"><a></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(rentabilidade, </span>
<span id="cb31-5"><a></a>            <span class="fu">aes</span>(<span class="at">x =</span> cultura, <span class="at">y =</span> margem_media, <span class="at">fill =</span> fazenda,</span>
<span id="cb31-6"><a></a>                <span class="at">text =</span> <span class="fu">paste</span>(<span class="st">"Fazenda:"</span>, fazenda,</span>
<span id="cb31-7"><a></a>                            <span class="st">"&lt;br&gt;Margem:"</span>, <span class="fu">round</span>(margem_media, <span class="dv">1</span>), <span class="st">"%"</span>))) <span class="sc">+</span></span>
<span id="cb31-8"><a></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb31-9"><a></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Margem de Lucro por Cultura e Fazenda"</span>) <span class="sc">+</span></span>
<span id="cb31-10"><a></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb31-11"><a></a></span>
<span id="cb31-12"><a></a><span class="co"># Converter para interativo</span></span>
<span id="cb31-13"><a></a><span class="fu">ggplotly</span>(p, <span class="at">tooltip =</span> <span class="st">"text"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Vantagens:</strong> Hover, zoom, exportar gr√°fico, interatividade!</p>
</section>
<section id="renderizando-o-relat√≥rio" class="slide level2">
<h2>8.5 Renderizando o Relat√≥rio</h2>
<p><strong>Via RStudio:</strong></p>
<ul>
<li>Bot√£o ‚ÄúRender‚Äù no editor</li>
</ul>
<p><strong>Via c√≥digo R:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a></a><span class="fu">library</span>(quarto)</span>
<span id="cb32-2"><a></a></span>
<span id="cb32-3"><a></a><span class="fu">quarto_render</span>(<span class="st">"relatorio_datalake.qmd"</span>)</span>
<span id="cb32-4"><a></a></span>
<span id="cb32-5"><a></a><span class="co"># Ou especificar formato</span></span>
<span id="cb32-6"><a></a><span class="fu">quarto_render</span>(<span class="st">"relatorio_datalake.qmd"</span>, <span class="at">output_format =</span> <span class="st">"pdf"</span>)</span>
<span id="cb32-7"><a></a></span>
<span id="cb32-8"><a></a><span class="co"># M√∫ltiplos formatos</span></span>
<span id="cb32-9"><a></a><span class="fu">quarto_render</span>(<span class="st">"relatorio_datalake.qmd"</span>, </span>
<span id="cb32-10"><a></a>              <span class="at">output_format =</span> <span class="st">"all"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Via terminal:</strong></p>
<div class="sourceCode" id="cb33"><pre class="sourceCode numberSource bash number-lines code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a></a><span class="ex">quarto</span> render relatorio_datalake.qmd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="automatiza√ß√£o-com-github-actions" class="slide level2">
<h2>8.6 Automatiza√ß√£o com GitHub Actions</h2>
<p><strong>Exemplo de workflow <code>.github/workflows/render.yml</code>:</strong></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode numberSource yaml number-lines code-with-copy"><code class="sourceCode yaml"><span id="cb34-1"><a></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Render Relat√≥rio</span></span>
<span id="cb34-2"><a></a></span>
<span id="cb34-3"><a></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb34-4"><a></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span></span>
<span id="cb34-5"><a></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">cron</span><span class="kw">:</span><span class="at"> </span><span class="st">'0 9 * * 1'</span><span class="co">  # Toda segunda √†s 9h</span></span>
<span id="cb34-6"><a></a><span class="at">  </span><span class="fu">workflow_dispatch</span><span class="kw">:</span></span>
<span id="cb34-7"><a></a></span>
<span id="cb34-8"><a></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb34-9"><a></a><span class="at">  </span><span class="fu">render</span><span class="kw">:</span></span>
<span id="cb34-10"><a></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb34-11"><a></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb34-12"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb34-13"><a></a><span class="at">      </span></span>
<span id="cb34-14"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> r-lib/actions/setup-r@v2</span></span>
<span id="cb34-15"><a></a><span class="at">      </span></span>
<span id="cb34-16"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install Quarto</span></span>
<span id="cb34-17"><a></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> quarto-dev/quarto-actions/setup@v2</span></span>
<span id="cb34-18"><a></a><span class="at">      </span></span>
<span id="cb34-19"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install packages</span></span>
<span id="cb34-20"><a></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb34-21"><a></a>          install.packages(c("bigrquery", "dplyr", </span>
<span id="cb34-22"><a></a>                            "ggplot2", "gt"))</span>
<span id="cb34-23"><a></a><span class="at">        </span><span class="fu">shell</span><span class="kw">:</span><span class="at"> Rscript {0}</span></span>
<span id="cb34-24"><a></a><span class="at">      </span></span>
<span id="cb34-25"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Render</span></span>
<span id="cb34-26"><a></a><span class="at">        </span><span class="fu">run</span><span class="kw">:</span><span class="at"> quarto render relatorio_datalake.qmd</span></span>
<span id="cb34-27"><a></a><span class="at">      </span></span>
<span id="cb34-28"><a></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy</span></span>
<span id="cb34-29"><a></a><span class="co">        # ... deploy para S3, GitHub Pages, etc.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="governan√ßa-e-compartilhamento" class="title-slide slide level1 center" data-background-color="#4285F4">
<h1>9. Governan√ßa e Compartilhamento</h1>

</section>
<section id="controle-de-acesso-no-bigquery" class="slide level2">
<h2>9.1 Controle de Acesso no BigQuery</h2>
<p><strong>N√≠veis de permiss√£o:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a></a><span class="co"># Ver permiss√µes atuais de um dataset</span></span>
<span id="cb35-2"><a></a><span class="fu">bq_dataset_meta</span>(<span class="fu">bq_dataset</span>(project_id, <span class="st">"gold"</span>))<span class="sc">$</span>access</span>
<span id="cb35-3"><a></a></span>
<span id="cb35-4"><a></a><span class="co"># Adicionar usu√°rio com acesso de leitura</span></span>
<span id="cb35-5"><a></a><span class="co"># (via console ou bq CLI √© mais comum)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Roles principais:</strong></p>
<ul>
<li><strong>Viewer:</strong> Apenas leitura</li>
<li><strong>Editor:</strong> Ler e modificar</li>
<li><strong>Owner:</strong> Controle total</li>
<li><strong>Custom roles:</strong> Permiss√µes espec√≠ficas</li>
</ul>
</section>
<section id="organizando-permiss√µes" class="slide level2">
<h2>9.2 Organizando Permiss√µes</h2>
<p><strong>Estrat√©gia recomendada:</strong></p>
<p><strong>Bronze:</strong> - Acesso restrito (apenas equipe de engenharia)</p>
<p><strong>Silver:</strong> - Leitura: Analistas e cientistas de dados - Escrita: Equipe de engenharia</p>
<p><strong>Gold:</strong> - Leitura: Todos os stakeholders - Escrita: Apenas processos automatizados</p>
<p><strong>Implementar via Google Groups para facilitar gest√£o</strong></p>
</section>
<section id="documenta√ß√£o-de-tabelas" class="slide level2">
<h2>9.3 Documenta√ß√£o de Tabelas</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a></a><span class="co"># Adicionar descri√ß√£o √†s tabelas</span></span>
<span id="cb36-2"><a></a><span class="fu">bq_table_meta</span>(</span>
<span id="cb36-3"><a></a>  <span class="fu">bq_table</span>(project_id, <span class="st">"gold"</span>, <span class="st">"agg_visao_consolidada"</span>),</span>
<span id="cb36-4"><a></a>  <span class="at">description =</span> <span class="st">"Vis√£o consolidada de rentabilidade por fazenda, </span></span>
<span id="cb36-5"><a></a><span class="st">                 cultura e ano. Atualizada diariamente √†s 6h."</span></span>
<span id="cb36-6"><a></a>)</span>
<span id="cb36-7"><a></a></span>
<span id="cb36-8"><a></a><span class="co"># Adicionar descri√ß√£o de campos (schema)</span></span>
<span id="cb36-9"><a></a>schema <span class="ot">&lt;-</span> <span class="fu">bq_table_meta</span>(</span>
<span id="cb36-10"><a></a>  <span class="fu">bq_table</span>(project_id, <span class="st">"gold"</span>, <span class="st">"agg_visao_consolidada"</span>)</span>
<span id="cb36-11"><a></a>)<span class="sc">$</span>schema<span class="sc">$</span>fields</span>
<span id="cb36-12"><a></a></span>
<span id="cb36-13"><a></a><span class="co"># Para adicionar descri√ß√µes aos campos, √© melhor fazer no console</span></span>
<span id="cb36-14"><a></a><span class="co"># ou criar um JSON com schema completo</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Importante:</strong> Documentar sempre: - O que a tabela cont√©m - Frequ√™ncia de atualiza√ß√£o - Regras de neg√≥cio aplicadas - Contato do respons√°vel</p>
</section>
<section id="versionamento-de-c√≥digo" class="slide level2">
<h2>9.4 Versionamento de C√≥digo</h2>
<p><strong>Estrutura de reposit√≥rio Git:</strong></p>
<pre><code>datalake-agricola/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ project_config.R
‚îÇ   ‚îî‚îÄ‚îÄ database_schema.sql
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ 01_setup_datasets.R
‚îÇ   ‚îú‚îÄ‚îÄ 02_bronze_ingestion.R
‚îÇ   ‚îú‚îÄ‚îÄ 03_silver_transformation.R
‚îÇ   ‚îú‚îÄ‚îÄ 04_gold_aggregation.R
‚îÇ   ‚îî‚îÄ‚îÄ 05_update_pipeline.R
‚îú‚îÄ‚îÄ reports/
‚îÇ   ‚îú‚îÄ‚îÄ relatorio_mensal.qmd
‚îÇ   ‚îî‚îÄ‚îÄ dashboard_executivo.qmd
‚îú‚îÄ‚îÄ functions/
‚îÇ   ‚îú‚îÄ‚îÄ auth_utils.R
‚îÇ   ‚îú‚îÄ‚îÄ data_quality.R
‚îÇ   ‚îî‚îÄ‚îÄ transformation_helpers.R
‚îî‚îÄ‚îÄ tests/
    ‚îî‚îÄ‚îÄ test_transformations.R</code></pre>
</section>
<section id="pipeline-automatizado" class="slide level2">
<h2>9.5 Pipeline Automatizado</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a></a><span class="co"># Criar script mestre: update_pipeline.R</span></span>
<span id="cb38-2"><a></a></span>
<span id="cb38-3"><a></a><span class="fu">library</span>(bigrquery)</span>
<span id="cb38-4"><a></a><span class="fu">library</span>(dplyr)</span>
<span id="cb38-5"><a></a><span class="fu">library</span>(logger)</span>
<span id="cb38-6"><a></a></span>
<span id="cb38-7"><a></a><span class="co"># Configurar log</span></span>
<span id="cb38-8"><a></a><span class="fu">log_info</span>(<span class="st">"Iniciando pipeline de atualiza√ß√£o do Data Lake"</span>)</span>
<span id="cb38-9"><a></a></span>
<span id="cb38-10"><a></a><span class="co"># 1. Ingest√£o Bronze</span></span>
<span id="cb38-11"><a></a><span class="fu">log_info</span>(<span class="st">"Etapa 1: Ingest√£o de dados brutos"</span>)</span>
<span id="cb38-12"><a></a><span class="fu">source</span>(<span class="st">"scripts/02_bronze_ingestion.R"</span>)</span>
<span id="cb38-13"><a></a></span>
<span id="cb38-14"><a></a><span class="co"># 2. Transforma√ß√£o Silver</span></span>
<span id="cb38-15"><a></a><span class="fu">log_info</span>(<span class="st">"Etapa 2: Limpeza e valida√ß√£o"</span>)</span>
<span id="cb38-16"><a></a><span class="fu">source</span>(<span class="st">"scripts/03_silver_transformation.R"</span>)</span>
<span id="cb38-17"><a></a></span>
<span id="cb38-18"><a></a><span class="co"># 3. Agrega√ß√£o Gold</span></span>
<span id="cb38-19"><a></a><span class="fu">log_info</span>(<span class="st">"Etapa 3: Cria√ß√£o de agrega√ß√µes"</span>)</span>
<span id="cb38-20"><a></a><span class="fu">source</span>(<span class="st">"scripts/04_gold_aggregation.R"</span>)</span>
<span id="cb38-21"><a></a></span>
<span id="cb38-22"><a></a><span class="co"># 4. Valida√ß√£o de qualidade</span></span>
<span id="cb38-23"><a></a><span class="fu">log_info</span>(<span class="st">"Etapa 4: Valida√ß√£o de qualidade dos dados"</span>)</span>
<span id="cb38-24"><a></a><span class="fu">source</span>(<span class="st">"tests/test_transformations.R"</span>)</span>
<span id="cb38-25"><a></a></span>
<span id="cb38-26"><a></a><span class="co"># 5. Atualizar relat√≥rio</span></span>
<span id="cb38-27"><a></a><span class="fu">log_info</span>(<span class="st">"Etapa 5: Renderiza√ß√£o de relat√≥rios"</span>)</span>
<span id="cb38-28"><a></a>quarto<span class="sc">::</span><span class="fu">quarto_render</span>(<span class="st">"reports/relatorio_mensal.qmd"</span>)</span>
<span id="cb38-29"><a></a></span>
<span id="cb38-30"><a></a><span class="fu">log_info</span>(<span class="st">"Pipeline conclu√≠do com sucesso!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="agendamento-com-cronr" class="slide level2">
<h2>9.6 Agendamento com cronR</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a></a><span class="fu">library</span>(cronR)</span>
<span id="cb39-2"><a></a></span>
<span id="cb39-3"><a></a><span class="co"># Criar cron job para executar pipeline diariamente</span></span>
<span id="cb39-4"><a></a>cmd <span class="ot">&lt;-</span> <span class="fu">cron_rscript</span>(</span>
<span id="cb39-5"><a></a>  <span class="at">rscript =</span> <span class="st">"scripts/05_update_pipeline.R"</span>,</span>
<span id="cb39-6"><a></a>  <span class="at">rscript_log =</span> <span class="st">"logs/pipeline.log"</span>,</span>
<span id="cb39-7"><a></a>  <span class="at">log_append =</span> <span class="cn">TRUE</span></span>
<span id="cb39-8"><a></a>)</span>
<span id="cb39-9"><a></a></span>
<span id="cb39-10"><a></a><span class="co"># Agendar para 6h da manh√£ todos os dias</span></span>
<span id="cb39-11"><a></a><span class="fu">cron_add</span>(</span>
<span id="cb39-12"><a></a>  <span class="at">command =</span> cmd,</span>
<span id="cb39-13"><a></a>  <span class="at">frequency =</span> <span class="st">"daily"</span>,</span>
<span id="cb39-14"><a></a>  <span class="at">at =</span> <span class="st">"06:00"</span>,</span>
<span id="cb39-15"><a></a>  <span class="at">id =</span> <span class="st">"datalake_update"</span></span>
<span id="cb39-16"><a></a>)</span>
<span id="cb39-17"><a></a></span>
<span id="cb39-18"><a></a><span class="co"># Listar jobs agendados</span></span>
<span id="cb39-19"><a></a><span class="fu">cron_ls</span>()</span>
<span id="cb39-20"><a></a></span>
<span id="cb39-21"><a></a><span class="co"># Remover job</span></span>
<span id="cb39-22"><a></a><span class="co"># cron_rm("datalake_update")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Windows:</strong> Use Task Scheduler</p>
<p><strong>Linux:</strong> Crontab tradicional tamb√©m funciona</p>
</section>
<section id="monitoramento-de-custos" class="slide level2">
<h2>9.7 Monitoramento de Custos</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a></a><span class="co"># BigQuery cobra por quantidade de dados processados</span></span>
<span id="cb40-2"><a></a><span class="co"># Consultar uso recente</span></span>
<span id="cb40-3"><a></a></span>
<span id="cb40-4"><a></a><span class="co"># Ver custo estimado de uma query ANTES de executar</span></span>
<span id="cb40-5"><a></a>query <span class="ot">&lt;-</span> <span class="st">"SELECT * FROM `datalake-agricola.gold.agg_visao_consolidada`"</span></span>
<span id="cb40-6"><a></a></span>
<span id="cb40-7"><a></a>query_job <span class="ot">&lt;-</span> <span class="fu">bq_project_query</span>(project_id, query, <span class="at">dry_run =</span> <span class="cn">TRUE</span>)</span>
<span id="cb40-8"><a></a></span>
<span id="cb40-9"><a></a><span class="co"># Bytes que ser√£o processados</span></span>
<span id="cb40-10"><a></a>bytes_processed <span class="ot">&lt;-</span> query_job<span class="sc">$</span>statistics<span class="sc">$</span>query<span class="sc">$</span>totalBytesProcessed</span>
<span id="cb40-11"><a></a>gb_processed <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(bytes_processed) <span class="sc">/</span> <span class="fl">1e9</span></span>
<span id="cb40-12"><a></a></span>
<span id="cb40-13"><a></a><span class="co"># Custo: $5 por TB (ap√≥s 1TB gratuito/m√™s)</span></span>
<span id="cb40-14"><a></a>custo_estimado <span class="ot">&lt;-</span> (gb_processed <span class="sc">/</span> <span class="dv">1000</span>) <span class="sc">*</span> <span class="dv">5</span></span>
<span id="cb40-15"><a></a></span>
<span id="cb40-16"><a></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Query processar√° %.2f GB</span><span class="sc">\n</span><span class="st">"</span>, gb_processed))</span>
<span id="cb40-17"><a></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Custo estimado: $%.4f</span><span class="sc">\n</span><span class="st">"</span>, custo_estimado))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Dicas para reduzir custos:</strong></p>
<ul>
<li>Use particionamento por data</li>
<li>Selecione apenas colunas necess√°rias</li>
<li>Use clustering para queries frequentes</li>
<li>Materialize resultados intermedi√°rios</li>
</ul>
</section>
<section id="particionamento-de-tabelas" class="slide level2">
<h2>9.8 Particionamento de Tabelas</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a></a><span class="co"># Para tabelas grandes, particionar por data economiza muito!</span></span>
<span id="cb41-2"><a></a></span>
<span id="cb41-3"><a></a><span class="co"># Query SQL para criar tabela particionada</span></span>
<span id="cb41-4"><a></a>query_criar_particionada <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb41-5"><a></a><span class="st">  CREATE TABLE `datalake-agricola.silver.safras_cleaned_partitioned`</span></span>
<span id="cb41-6"><a></a><span class="st">  PARTITION BY DATE(data_plantio)</span></span>
<span id="cb41-7"><a></a><span class="st">  CLUSTER BY fazenda, cultura</span></span>
<span id="cb41-8"><a></a><span class="st">  AS</span></span>
<span id="cb41-9"><a></a><span class="st">  SELECT * FROM `datalake-agricola.silver.safras_cleaned`</span></span>
<span id="cb41-10"><a></a><span class="st">"</span></span>
<span id="cb41-11"><a></a></span>
<span id="cb41-12"><a></a><span class="fu">bq_project_query</span>(project_id, query_criar_particionada)</span>
<span id="cb41-13"><a></a></span>
<span id="cb41-14"><a></a><span class="co"># Agora queries que filtram por data_plantio ser√£o muito mais baratas!</span></span>
<span id="cb41-15"><a></a><span class="co"># Exemplo: SELECT * WHERE data_plantio &gt;= '2023-01-01'</span></span>
<span id="cb41-16"><a></a><span class="co"># Processa apenas a parti√ß√£o de 2023, n√£o toda a tabela</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compartilhando-acesso-a-dados" class="slide level2">
<h2>9.9 Compartilhando Acesso a Dados</h2>
<p><strong>M√©todo 1: Authorized Views</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a></a><span class="co"># Criar view que limita acesso a dados sens√≠veis</span></span>
<span id="cb42-2"><a></a>query_view_publica <span class="ot">&lt;-</span> <span class="st">"</span></span>
<span id="cb42-3"><a></a><span class="st">  CREATE VIEW `datalake-agricola.gold.producao_publica` AS</span></span>
<span id="cb42-4"><a></a><span class="st">  SELECT </span></span>
<span id="cb42-5"><a></a><span class="st">    cultura,</span></span>
<span id="cb42-6"><a></a><span class="st">    ano_safra,</span></span>
<span id="cb42-7"><a></a><span class="st">    SUM(area_total_ha) as area_total,</span></span>
<span id="cb42-8"><a></a><span class="st">    SUM(producao_total_ton) as producao_total,</span></span>
<span id="cb42-9"><a></a><span class="st">    AVG(produtividade_media) as produtividade_media</span></span>
<span id="cb42-10"><a></a><span class="st">  FROM `datalake-agricola.gold.agg_visao_consolidada`</span></span>
<span id="cb42-11"><a></a><span class="st">  GROUP BY cultura, ano_safra</span></span>
<span id="cb42-12"><a></a><span class="st">"</span></span>
<span id="cb42-13"><a></a></span>
<span id="cb42-14"><a></a><span class="fu">bq_project_query</span>(project_id, query_view_publica)</span>
<span id="cb42-15"><a></a></span>
<span id="cb42-16"><a></a><span class="co"># Dar acesso apenas √† view, n√£o √†s tabelas originais</span></span>
<span id="cb42-17"><a></a><span class="co"># Usu√°rios veem dados agregados, mas n√£o detalhes sens√≠veis</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-catalog-e-metadados" class="slide level2">
<h2>9.10 Data Catalog e Metadados</h2>
<p><strong>Organizar com tags:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a></a><span class="co"># Adicionar tags para facilitar descoberta</span></span>
<span id="cb43-2"><a></a><span class="co"># Fazer via console ou Data Catalog API</span></span>
<span id="cb43-3"><a></a></span>
<span id="cb43-4"><a></a><span class="co"># Exemplo de estrutura de tags:</span></span>
<span id="cb43-5"><a></a><span class="co"># - ambiente: producao | desenvolvimento</span></span>
<span id="cb43-6"><a></a><span class="co"># - sensibilidade: publica | interna | confidencial</span></span>
<span id="cb43-7"><a></a><span class="co"># - dominio: agricultura | financeiro | operacional</span></span>
<span id="cb43-8"><a></a><span class="co"># - frequencia_atualizacao: diaria | semanal | mensal</span></span>
<span id="cb43-9"><a></a><span class="co"># - responsavel: equipe-dados | equipe-engenharia</span></span>
<span id="cb43-10"><a></a></span>
<span id="cb43-11"><a></a><span class="co"># Documentar no README.md:</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>README.md do projeto:</strong></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb44-1"><a></a><span class="fu"># Data Lake Agr√≠cola - GCP</span></span>
<span id="cb44-2"><a></a></span>
<span id="cb44-3"><a></a><span class="fu">## Estrutura</span></span>
<span id="cb44-4"><a></a><span class="ss">- </span>Bronze: Dados brutos preservados</span>
<span id="cb44-5"><a></a><span class="ss">- </span>Silver: Dados limpos e validados</span>
<span id="cb44-6"><a></a><span class="ss">- </span>Gold: Agrega√ß√µes prontas para an√°lise</span>
<span id="cb44-7"><a></a></span>
<span id="cb44-8"><a></a><span class="fu">## Tabelas Principais</span></span>
<span id="cb44-9"><a></a><span class="pp">|</span> Tabela <span class="pp">|</span> Descri√ß√£o <span class="pp">|</span> Atualiza√ß√£o <span class="pp">|</span></span>
<span id="cb44-10"><a></a><span class="pp">|--------|-----------|-------------|</span></span>
<span id="cb44-11"><a></a><span class="pp">|</span> gold.agg_visao_consolidada <span class="pp">|</span> M√©tricas consolidadas <span class="pp">|</span> Di√°ria <span class="pp">|</span></span>
<span id="cb44-12"><a></a><span class="pp">|</span> silver.safras_cleaned <span class="pp">|</span> Safras validadas <span class="pp">|</span> Di√°ria <span class="pp">|</span></span>
<span id="cb44-13"><a></a><span class="pp">|</span> bronze.raw_safras <span class="pp">|</span> Dados brutos de safra <span class="pp">|</span> Tempo real <span class="pp">|</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="melhores-pr√°ticas" class="title-slide slide level1 center" data-background-color="#34A853">
<h1>Melhores Pr√°ticas</h1>

</section>
<section id="checklist-de-qualidade" class="slide level2">
<h2>Checklist de Qualidade</h2>
<p><strong>‚úÖ Estrutura:</strong></p>
<ul>
<li>Separa√ß√£o clara Bronze ‚Üí Silver ‚Üí Gold</li>
<li>Nomenclatura consistente</li>
<li>Documenta√ß√£o de cada camada</li>
</ul>
<p><strong>‚úÖ C√≥digo:</strong></p>
<ul>
<li>Versionamento Git</li>
<li>Fun√ß√µes reutiliz√°veis</li>
<li>Testes automatizados</li>
<li>Logs de execu√ß√£o</li>
</ul>
<p><strong>‚úÖ Dados:</strong></p>
<ul>
<li>Valida√ß√£o de qualidade</li>
<li>Tratamento de nulos</li>
<li>Deduplica√ß√£o</li>
<li>Rastreamento de linhagem</li>
</ul>
</section>
<section id="dicas-de-performance" class="slide level2">
<h2>Dicas de Performance</h2>
<p><strong>1. Use dbplyr sempre que poss√≠vel</strong> - Processa no servidor, n√£o na mem√≥ria local</p>
<p><strong>2. Materialize resultados intermedi√°rios</strong> - Evite reprocessar dados j√° calculados</p>
<p><strong>3. Particione tabelas grandes</strong> - Por data √© o mais comum</p>
<p><strong>4. Use clustering</strong> - Para campos frequentemente filtrados</p>
<p><strong>5. Limite <code>collect()</code></strong> - Traga apenas dados necess√°rios para R</p>
<p><strong>6. Cache de autentica√ß√£o</strong> - Use <code>gargle::credentials_service_account()</code></p>
</section>
<section id="seguran√ßa-e-conformidade" class="slide level2">
<h2>Seguran√ßa e Conformidade</h2>
<p><strong>Dados sens√≠veis:</strong></p>
<ul>
<li>Nunca versione credenciais</li>
<li>Use vari√°veis de ambiente</li>
<li>Implemente row-level security se necess√°rio</li>
<li>Audite acessos regularmente</li>
</ul>
<p><strong>LGPD/GDPR:</strong></p>
<ul>
<li>Documente fluxo de dados pessoais</li>
<li>Implemente mecanismos de dele√ß√£o</li>
<li>Controle quem acessa o qu√™</li>
<li>Mantenha logs de acesso</li>
</ul>
<p><strong>Backup:</strong></p>
<ul>
<li>BigQuery mant√©m hist√≥rico autom√°tico (7 dias)</li>
<li>Exporte periodicamente para Cloud Storage</li>
<li>Teste procedimentos de recupera√ß√£o</li>
</ul>
</section>
<section id="evolu√ß√£o-do-data-lake" class="slide level2">
<h2>Evolu√ß√£o do Data Lake</h2>
<p><strong>Pr√≥ximos passos:</strong></p>
<p><strong>N√≠vel 1 (voc√™ est√° aqui):</strong> ‚úÖ Estrutura Bronze-Silver-Gold ‚úÖ Pipeline em R ‚úÖ An√°lises b√°sicas</p>
<p><strong>N√≠vel 2:</strong> - üîÑ Orquestra√ß√£o com Apache Airflow - üìä Dashboards em tempo real - ü§ñ ML direto no BigQuery</p>
<p><strong>N√≠vel 3:</strong> - üåä Streaming de dados - üîç Data Quality automatizado - üìà Self-service analytics</p>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="recursos-e-refer√™ncias" class="title-slide slide level1 center" data-background-color="#FBBC04">
<h1>Recursos e Refer√™ncias</h1>

</section>
<section id="documenta√ß√£o-oficial" class="slide level2">
<h2>Documenta√ß√£o Oficial</h2>
<p><strong>Google Cloud:</strong></p>
<ul>
<li>BigQuery Documentation: https://cloud.google.com/bigquery/docs</li>
<li>Cloud Storage: https://cloud.google.com/storage/docs</li>
<li>IAM &amp; Security: https://cloud.google.com/iam/docs</li>
</ul>
<p><strong>R Packages:</strong></p>
<ul>
<li>bigrquery: https://bigrquery.r-dbi.org</li>
<li>dbplyr: https://dbplyr.tidyverse.org</li>
<li>DBI: https://dbi.r-dbi.org</li>
</ul>
</section>
<section id="comunidade-e-aprendizado" class="slide level2">
<h2>Comunidade e Aprendizado</h2>
<p><strong>Onde aprender mais:</strong></p>
<ul>
<li>R-Bloggers: posts sobre BigQuery + R</li>
<li>Stack Overflow: [r] + [google-bigquery]</li>
<li>GitHub: projetos open source de Data Lakes</li>
<li>Medium: artigos sobre arquiteturas de dados</li>
</ul>
<p><strong>Datasets para praticar:</strong></p>
<ul>
<li>BigQuery Public Datasets</li>
<li>Kaggle Agricultural Datasets</li>
<li>dados.gov.br (dados abertos brasileiros)</li>
</ul>
</section>
<section id="ferramentas-complementares" class="slide level2">
<h2>Ferramentas Complementares</h2>
<p><strong>Visualiza√ß√£o:</strong></p>
<ul>
<li>Looker Studio (Google Data Studio)</li>
<li>Shiny Apps conectados ao BigQuery</li>
<li>Tableau / Power BI</li>
</ul>
<p><strong>Orquestra√ß√£o:</strong></p>
<ul>
<li>Apache Airflow</li>
<li>Google Cloud Composer</li>
<li>Prefect</li>
</ul>
<p><strong>CI/CD:</strong></p>
<ul>
<li>GitHub Actions</li>
<li>GitLab CI</li>
<li>Google Cloud Build</li>
</ul>
</section>
<section id="exemplo-de-projeto-completo" class="slide level2">
<h2>Exemplo de Projeto Completo</h2>
<p><strong>Reposit√≥rio no GitHub:</strong></p>
<pre><code>https://github.com/seu-usuario/datalake-agricola-gcp</code></pre>
<p><strong>Estrutura completa:</strong></p>
<ul>
<li>‚úÖ Scripts de setup</li>
<li>‚úÖ Pipeline completo Bronze-Silver-Gold</li>
<li>‚úÖ Testes automatizados</li>
<li>‚úÖ Relat√≥rios Quarto</li>
<li>‚úÖ Documenta√ß√£o</li>
<li>‚úÖ Exemplos de an√°lises</li>
<li>‚úÖ Docker para reprodutibilidade</li>
</ul>
<p><strong>Clone e adapte para seus dados!</strong></p>
</section>
<section class="slide level2">

</section></section>
<section>
<section id="conclus√£o" class="title-slide slide level1 center" data-background-color="#4285F4">
<h1>Conclus√£o</h1>

</section>
<section id="o-que-aprendemos" class="slide level2">
<h2>O que aprendemos</h2>
<p><strong>Jornada completa:</strong></p>
<p>‚úÖ Setup GCP e autentica√ß√£o ‚úÖ Estrutura Bronze-Silver-Gold ‚úÖ Ingest√£o e transforma√ß√£o em R ‚úÖ Agrega√ß√µes anal√≠ticas ‚úÖ Consumo com dplyr/dbplyr ‚úÖ Relat√≥rios reprodut√≠veis ‚úÖ Governan√ßa e seguran√ßa ‚úÖ Melhores pr√°ticas</p>
<p><strong>Voc√™ agora tem:</strong></p>
<p>Uma arquitetura completa de Data Lake profissional, escal√°vel e mantida principalmente em R!</p>
</section>
<section id="pr√≥ximos-passos" class="slide level2">
<h2>Pr√≥ximos Passos</h2>
<p><strong>Continue praticando:</strong></p>
<ol type="1">
<li><strong>Implemente com seus dados reais</strong>
<ul>
<li>Adapte o pipeline</li>
<li>Ajuste transforma√ß√µes</li>
</ul></li>
<li><strong>Automatize completamente</strong>
<ul>
<li>Adicione orquestra√ß√£o</li>
<li>Configure alertas</li>
</ul></li>
<li><strong>Compartilhe conhecimento</strong>
<ul>
<li>Documente decis√µes</li>
<li>Ensine sua equipe</li>
</ul></li>
<li><strong>Evolua continuamente</strong>
<ul>
<li>Monitore performance</li>
<li>Otimize custos</li>
<li>Adicione features</li>
</ul></li>
</ol>
</section>
<section id="agradecimentos" class="slide level2" data-background-color="#34A853">
<h2>Agradecimentos</h2>
<p><strong>Obrigado por acompanhar esta apresenta√ß√£o!</strong></p>
<p><strong>Recursos √∫teis:</strong></p>
<ul>
<li>üìß Email: seu-email@example.com</li>
<li>üíº LinkedIn: /seu-perfil</li>
<li>üêô GitHub: /seu-usuario</li>
<li>üìù Blog: seu-blog.com</li>
</ul>
<p><strong>√â OPEN USE, USE E COMPARTILHE!</strong></p>
<p><strong>D√∫vidas? Discuss√µes? Contribui√ß√µes?</strong></p>
<p>Abra uma issue no reposit√≥rio ou entre em contato!</p>
</section>
<section id="refer√™ncias-bibliogr√°ficas" class="slide level2">
<h2>Refer√™ncias Bibliogr√°ficas</h2>
<p><strong>Livros:</strong></p>
<ul>
<li><em>The Data Warehouse Toolkit</em> - Ralph Kimball</li>
<li><em>Designing Data-Intensive Applications</em> - Martin Kleppmann</li>
<li><em>R for Data Science</em> - Hadley Wickham</li>
</ul>
<p><strong>Papers:</strong></p>
<ul>
<li>Delta Lake: High-Performance ACID Table Storage</li>
<li>The Data Lakehouse: Building the Next Generation</li>
<li>BigQuery Architecture Paper (Google)</li>
</ul>
<p><strong>Cursos:</strong></p>
<ul>
<li>Google Cloud Skills Boost</li>
<li>Coursera: Data Engineering on GCP</li>
<li>RStudio Education: Databases using R</li>
</ul>
</section>
<section class="slide level2">

</section></section>
<section id="obrigado" class="title-slide slide level1 center" data-background-color="#4285F4">
<h1>Obrigado!</h1>
<p><strong>Voc√™ est√° pronto para construir seu Data Lake!</strong></p>

<img data-src="https://www.r-project.org/logo/Rlogo.png" class="quarto-figure quarto-figure-center r-stretch" width="200"><p><strong>üöÄ Bora codar!</strong></p>
<p><strong>‚≠ê Se gostou, compartilhe!</strong></p>


</section>
    </div>
  <div class="quarto-auto-generated-content" style="display: none;">
<p><img src="imagens/cafe1.png" class="slide-logo"></p>
<div class="footer footer-default">
<p>Data Lake GCP com R ‚Ä¢ Arquitetura Bronze-Silver-Gold</p>
</div>
</div></div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="../site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="../site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="../site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="../site_libs/revealjs/plugin/reveal-chalkboard/plugin.js"></script>
  <script src="../site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="../site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="../site_libs/revealjs/plugin/search/search.js"></script>
  <script src="../site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="../site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': true,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'jumpToSlide': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleScrollView(event)\"><kbd>r</kbd> Scroll View Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"5\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleChalkboard(event)\"><kbd>b</kbd> Toggle Chalkboard</a></li>\n<li class=\"slide-tool-item\" data-item=\"6\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.toggleNotesCanvas(event)\"><kbd>c</kbd> Toggle Notes Canvas</a></li>\n<li class=\"slide-tool-item\" data-item=\"7\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.downloadDrawings(event)\"><kbd>d</kbd> Download Drawings</a></li>\n<li class=\"slide-tool-item\" data-item=\"8\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'chalkboard': {"buttons":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: 'c/t',

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'slide',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, RevealChalkboard, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    

    <script>

      // htmlwidgets need to know to resize themselves when slides are shown/hidden.

      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current

      // slide changes (different for each slide format).

      (function () {

        // dispatch for htmlwidgets

        function fireSlideEnter() {

          const event = window.document.createEvent("Event");

          event.initEvent("slideenter", true, true);

          window.document.dispatchEvent(event);

        }

    

        function fireSlideChanged(previousSlide, currentSlide) {

          fireSlideEnter();

    

          // dispatch for shiny

          if (window.jQuery) {

            if (previousSlide) {

              window.jQuery(previousSlide).trigger("hidden");

            }

            if (currentSlide) {

              window.jQuery(currentSlide).trigger("shown");

            }

          }

        }

    

        // hookup for slidy

        if (window.w3c_slidy) {

          window.w3c_slidy.add_observer(function (slide_num) {

            // slide_num starts at position 1

            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);

          });

        }

    

      })();

    </script>

    

    <script id="quarto-html-after-body" type="application/javascript">
      window.document.addEventListener("DOMContentLoaded", function (event) {
        const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
        tabsets.forEach(function(tabset) {
          const tabby = new Tabby('#' + tabset.id);
        });
        const isCodeAnnotation = (el) => {
          for (const clz of el.classList) {
            if (clz.startsWith('code-annotation-')) {                     
              return true;
            }
          }
          return false;
        }
        const onCopySuccess = function(e) {
          // button target
          const button = e.trigger;
          // don't keep focus
          button.blur();
          // flash "checked"
          button.classList.add('code-copy-button-checked');
          var currentTitle = button.getAttribute("title");
          button.setAttribute("title", "Copied!");
          let tooltip;
          if (window.bootstrap) {
            button.setAttribute("data-bs-toggle", "tooltip");
            button.setAttribute("data-bs-placement", "left");
            button.setAttribute("data-bs-title", "Copied!");
            tooltip = new bootstrap.Tooltip(button, 
              { trigger: "manual", 
                customClass: "code-copy-button-tooltip",
                offset: [0, -8]});
            tooltip.show();    
          }
          setTimeout(function() {
            if (tooltip) {
              tooltip.hide();
              button.removeAttribute("data-bs-title");
              button.removeAttribute("data-bs-toggle");
              button.removeAttribute("data-bs-placement");
            }
            button.setAttribute("title", currentTitle);
            button.classList.remove('code-copy-button-checked');
          }, 1000);
          // clear code selection
          e.clearSelection();
        }
        const getTextToCopy = function(trigger) {
            const codeEl = trigger.previousElementSibling.cloneNode(true);
            for (const childEl of codeEl.children) {
              if (isCodeAnnotation(childEl)) {
                childEl.remove();
              }
            }
            return codeEl.innerText;
        }
        const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
          text: getTextToCopy
        });
        clipboard.on('success', onCopySuccess);
        if (window.document.getElementById('quarto-embedded-source-code-modal')) {
          const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
            text: getTextToCopy,
            container: window.document.getElementById('quarto-embedded-source-code-modal')
          });
          clipboardModal.on('success', onCopySuccess);
        }
          var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
          var mailtoRegex = new RegExp(/^mailto:/);
            var filterRegex = new RegExp("https:\/\/jenniferlopes\.quarto\.pub\/portifolio");
          var isInternal = (href) => {
              return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
          }
          // Inspect non-navigation links and adorn them if external
         var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
          for (var i=0; i<links.length; i++) {
            const link = links[i];
            if (!isInternal(link.href)) {
              // undo the damage that might have been done by quarto-nav.js in the case of
              // links that we want to consider external
              if (link.dataset.originalHref !== undefined) {
                link.href = link.dataset.originalHref;
              }
            }
          }
        function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
          const config = {
            allowHTML: true,
            maxWidth: 500,
            delay: 100,
            arrow: false,
            appendTo: function(el) {
                return el.closest('section.slide') || el.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'light-border',
            placement: 'bottom-start',
          };
          if (contentFn) {
            config.content = contentFn;
          }
          if (onTriggerFn) {
            config.onTrigger = onTriggerFn;
          }
          if (onUntriggerFn) {
            config.onUntrigger = onUntriggerFn;
          }
            config['offset'] = [0,0];
            config['maxWidth'] = 700;
          window.tippy(el, config); 
        }
        const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
        for (var i=0; i<noterefs.length; i++) {
          const ref = noterefs[i];
          tippyHover(ref, function() {
            // use id or data attribute instead here
            let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
            try { href = new URL(href).hash; } catch {}
            const id = href.replace(/^#\/?/, "");
            const note = window.document.getElementById(id);
            if (note) {
              return note.innerHTML;
            } else {
              return "";
            }
          });
        }
        const findCites = (el) => {
          const parentEl = el.parentElement;
          if (parentEl) {
            const cites = parentEl.dataset.cites;
            if (cites) {
              return {
                el,
                cites: cites.split(' ')
              };
            } else {
              return findCites(el.parentElement)
            }
          } else {
            return undefined;
          }
        };
        var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
        for (var i=0; i<bibliorefs.length; i++) {
          const ref = bibliorefs[i];
          const citeInfo = findCites(ref);
          if (citeInfo) {
            tippyHover(citeInfo.el, function() {
              var popup = window.document.createElement('div');
              citeInfo.cites.forEach(function(cite) {
                var citeDiv = window.document.createElement('div');
                citeDiv.classList.add('hanging-indent');
                citeDiv.classList.add('csl-entry');
                var biblioDiv = window.document.getElementById('ref-' + cite);
                if (biblioDiv) {
                  citeDiv.innerHTML = biblioDiv.innerHTML;
                }
                popup.appendChild(citeDiv);
              });
              return popup.innerHTML;
            });
          }
        }
      });
      </script>
    

</body></html>